var version="0.23",alamode={reportError:function(t){$("<h1 class='mode-error'>").text(t).prependTo(document.body)},getColumnsFromQuery:function(e){var t=datasets.filter(function(t){if(t)return t.queryName==e})[0];return t?t.columns:(alamode.reportError("No such query: '"+e+"'"),[])},getDataFromQuery:function(e){var t=datasets.filter(function(t){if(t)return t.queryName==e})[0];return t?t.content:(alamode.reportError("No such query: '"+e+"'"),[])},makeId:function(t){for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",a="",n=0;n<t;n++)a+=e.charAt(Math.floor(Math.random()*e.length));return a},addContainerElement:function(t,e){return e=e||!1,id=alamode.makeId(10),"body"==t?$("<div id='"+id+"'></div>").addClass(id).addClass("mode-graphic-container").appendTo(".mode-content"):0===$(t).length?alamode.reportError("No such element: '"+t+"'"):(e&&$(t).empty(),$(t).addClass("mode-graphic-container"),$(t).addClass(id)),"."+id},addLinksToTables:function(t){var l="#"+t.table_id,e=t.link_columns,a=t.link_urls,n=t.query_name,m=t.open_in_new_tab||!1,r=[],h={};e.forEach(function(t,e){r.push({column:t,link_string:a[e]})});var p=alamode.getDataFromQuery(n);alamode.getColumnsFromQuery(n);function o(e){var t,a=$(l+" table"),n=$(l+" .js-header-table"),r=n?$(l+" .js-col-header"):$(n).find("th"),o=a.find("tr");r.each(function(){text=$(this).find(".axel-table-header-label").text(),t=$(this).attr("data-axel-column"),h[text]=t-1}),o.each(function(t){var c,u;0<t&&t<=p.length&&(c=$(this).find("td"),u=c.first().attr("data-axel-rowkey"),e.forEach(function(t){var e=h[t.column],a=c.eq(e).text();for(url=t.link_string;-1!=url.indexOf("{{");){var n=url.length,r=url.indexOf("{{"),o=url.substring(r+2,n).indexOf("}}"),l=url.substring(r+2,r+o+2),i=url.substring(r,r+o+4),d=(h[l],p[u][l]);url=url.replace(i,d)}var s="<a target='"+(m?"_blank":"_top")+"' href='"+encodeURI(url)+"'>"+a+"</a>";c.eq(e).html(s)}))})}setTimeout(function(){o(r)},1e3),$(l).mousemove(function(){o(r)})},customChartColors:function(t){var e=t.charts,n=t.colors,d=t.opacity,s=t.line_dashes;function h(t,e){var a=$("#"+t),n=(0<a.find(".nv-bar").length?a.find(".nv-group"):0<a.find(".nv-line").length||0<a.find(".nv-areaWrap").length?a.find(".nv-noninteractive"):a.find(".nv-pie .nv-slice")).length,r=a.find(".nv-series .nv-legend-symbol"),o={},l={},d={},s=0;if(0==r.length&&n<=1)l[0]=s,o[d[s]=0]=e[0];else if(0==r.length&&1<n)for(i=0;i<n;i++)l[i]=i,o=e;else for(i=0;i<r.length;i++)o[i]=e[i%Object.keys(e).length];return r.each(function(t){1==$(this).css("fill-opacity")?(l[t]=s,d[s]=t,s+=1):l[t]=-1}),{chart:a,legend:r,colors:o,m:l,r:d,seriesCount:n}}"all"==e&&(e=[],$("mode-chart").each(function(){e.push(this.id)})),setInterval(function(){e.forEach(function(t){!function(t,e){var a=h(t,e),n=a.chart,r=a.colors,o=a.m;for(var l in r)n.find(".nv-linesWrap .nv-groups .nv-series-"+o[l]).css({fill:r[l],stroke:r[l]}),n.find(".nv-barsWrap .nv-groups .nv-series-"+o[l]+" rect").css({fill:r[l],stroke:r[l]}),n.find(".nv-linePlusBar .nv-barsWrap .nv-bars rect").each(function(t){$(this).css({fill:r[0],stroke:r[0]})}),n.find(".nv-linePlusBar .nv-linesWrap .nv-groups .nv-series-0").css({fill:r[1],stroke:r[1]}),n.find(".nv-scatterWrap .nv-groups .nv-series-"+o[l]).css({fill:r[l],stroke:r[l]}),n.find(".nv-areaWrap .nv-area-"+o[l]).css({fill:r[l],stroke:r[l]}),n.find(".nv-pie .nv-slice").each(function(t){$(this).css({fill:r[t],stroke:r[t]})});for(var l in d)n.find(".nv-linesWrap .nv-groups .nv-series-"+o[l]).css({opacity:d[l]}),n.find(".nv-barsWrap .nv-groups .nv-series-"+o[l]+" rect").css({opacity:d[l]}),0==l&&(n.find(".nv-linePlusBar .nv-barsWrap .nv-bars rect").each(function(t){$(this).css({opacity:d[l]})}),n.find(".nv-linePlusBar .nv-linesWrap .nv-groups .nv-series-0").css({opacity:d[1]})),n.find(".nv-scatterWrap .nv-groups .nv-series-"+o[l]).css({opacity:d[l]}),n.find(".nv-areaWrap .nv-area-"+o[l]).css({opacity:d[l]}),n.find(".nv-pie .nv-slice").each(function(t){$(this).css({opacity:d[t]})});for(var l in s)n.find(".nv-linesWrap .nv-groups .nv-series-"+o[l]).css({"stroke-dasharray":s[l]});n.find(".nv-legendWrap .nv-series .nv-legend-symbol").each(function(t){$(this).css({fill:r[t],stroke:r[t]})})}(t,n)})},500),e.forEach(function(t){var a,u,m;a=t,u=n,m=$("#"+a),$(m).mousemove(function(){var t=h(a,u),n=t.legend,r=t.colors,o=t.r,l=t.m,i=t.seriesCount,d=isArea=m.find(".nv-area").length,s=m.find(".nv-bar").length,c=m.find(".nv-line").length;$("html").find(".nvtooltip table .legend-color-guide").each(function(t){var e,a;0==n.length&&0==s?$(this).find("div").css({"background-color":r[l[t]]}):0<c&&0<s?(e=m.find(".nv-linePlusBar .nv-linesWrap .nv-groups .nv-series-0").css("fill"),a=m.find(".nv-linePlusBar .nv-barsWrap .nv-bars rect").css("fill"),""==$(this).closest(".nvtooltip").find(".key")[0].innerText?$(this).find("div").css("background-color",a):$(this).find("div").css("background-color",e)):0<s?1==i&&$(this).find("div").css({"background-color":r[o[i-t-1]]}):0<d?$(this).find("div").css({"background-color":r[d-t-1]}):$(this).find("div").css({"background-color":r[t]})});var e=m.find(".nv-pie .nv-slice.hover").css("fill");$("html").find(".nvtooltip table .legend-color-guide div").css("background-color",e)}),$(m).mouseleave(function(){$("html").find(".nvtooltip table .legend-color-guide").remove()})})},addTotalsRow:function(t){var o,l,e,a=t.query_name,r="#"+(t.table_id||""),n=alamode.getColumnsFromQuery(a),i=alamode.getDataFromQuery(a),d=t.columns_with_totals,s=t.fmt||d3.format(","),c=(e=d,numberColumns=_.map(_.filter(n,function(t){return-1!=["number","integer","float"].indexOf(t.type)}),"name"),"all"==e?numberColumns:_.intersection(e,numberColumns)),u=(o=c,l=[],n.forEach(function(t,e){var a,n,r;r=-1==o.indexOf(t.name)?{idx:e,name:"",total:""}:(a=_.map(i,t.name),n=d3.sum(a),{idx:e,name:t.name,total:n}),l.push(r)}),l);setTimeout(function(){container="#"==r?(table=$(".main-table"),$(".js-table-content-container")):(table=$(r+" .main-table"),$(r+" .js-table-content-container"));var e,t=table.find("tr:last"),a=(e="<tr><td>TTL</td>",u.forEach(function(t){""!=t.total?e=e+"<td class='cell-type-number'>"+s(t.total)+"</td>":e+="<td></td>"}),e+"</tr>"),n=+container.css("height").match(/\d+/)[0];t.after(a),container.css("height",26+n)},1e3)},addImagesToTables:function(t){var o="#"+t.table,l=t.column,i=t.image_height||100;function e(){var t=$(o+" table"),e=$(o+" .js-header-table"),a=e?$(o+" .js-col-header"):$(e).find("th"),n=t.find("tr"),r=0;a.each(function(){text=$(this).find(".axel-table-header-label").text(),text==l&&(r=+$(this).attr("data-axel-column"))}),n.each(function(){$(this).find("td").each(function(t){var e;t==r-1&&(e=$(this).text(),0==$(this).find("img").length&&($(this).css("text-align","center"),$(this).html("<img style='height: "+i+"px;' src='"+e+"'>")))})})}setTimeout(function(){e()},1e3),$(o).keyup(function(){setTimeout(function(){e()},500)}),$(o).mousemove(function(){e()})},resizeChartHeight:function(t){var e=t.chart,a=t.height;"python"==e.slice(0,6)?($("#"+e+" .mode-python").css("height",a),$("#"+e+" .mode-python").css("max-height",a),$("#"+e+" img").css("max-height",a)):($("#"+e+" .chart").css("height",a),$("#"+e+" .chart-svg").css("height",a)),window.dispatchEvent(new Event("resize"))},retentionHeatmap:function(t){var a,n,r,e=t.query_name,i=t.cohort_column,d=t.pivot_column,s=t.value_column,o=t.color_gradient||["#d73027","#f46d43","#fdae61","#fee08b","#ffffbf","#d9ef8b","#a6d96a","#66bd63","#1a9850"],l=t.gradient_by||"all",c=t.gradient_column||s,u=t.total_column,m=t.html_element||"body",h=t.title||e,p=t.pivot_label||"",f=t.value_is_percent,v=t.precision||0,g=alamode.getDataFromQuery(e),y=alamode.getColumnsFromQuery(e),x=_.uniq(_.map(g,i)),b=_.sortBy(_.uniq(_.map(g,d))),w=alamode.addContainerElement(m);"cohort_column"===l?(a={},x.forEach(function(e){var t=g.filter(function(t){return t[i]===e});a[e]=d3.scale.quantize().domain(d3.extent(t,function(t){return t[c]})).range(o)})):"pivot_column"===l?(n={},b.forEach(function(e){var t=g.filter(function(t){return t[d]===e});n[e]=d3.scale.quantize().domain(d3.extent(t,function(t){return t[c]})).range(o)})):r=d3.scale.quantize().domain(d3.extent(g,function(t){return t[c]})).range(o),d3.select(w).append("div").attr("class","mode-graphic-title").text(h),d3.select(w).append("div").attr("class","mode-retention-heatmap-label").text(p),headers=u?[i,u].concat(b):[i].concat(b);var k=d3.select(w).append("table").attr("class","mode-retention-heatmap-table");function $(e){return y.filter(function(t){return t.name==e})[0].type}k.selectAll(".mode-retention-heatmap-table-header").data([0]).enter().append("tr").attr("class","mode-retention-heatmap-table-header").selectAll("mode-retention-heatmap-table-header-cell").data(headers).enter().append("td").attr("class",function(t){return isNaN(t)?"mode-retention-heatmap-table-header-cell heatmap-string":"mode-retention-heatmap-table-header-cell heatmap-number"}).text(function(t){return t}),k.selectAll(".mode-retention-heatmap-table-row").data(x).enter().append("tr").attr("class","mode-retention-heatmap-table-row").selectAll(".mode-retention-heatmap-table-cell").data(function(t){return function(r,o){var l=[{column:i,value:o}];{var t,e;u&&(t=_.filter(r,function(t){return t[i]==o})[0],e={column:u,value:t[u]},l=l.concat(e))}return b.forEach(function(e){var t="",a="",n=_.filter(r,function(t){return t[i]==o&&t[d]==e});0<n.length&&(t=d3.mean(_.map(n,s)),a=d3.mean(_.map(n,c))),l=l.concat({column:s,value:t,cohort:o,pivot:e,gradientValue:a})}),l}(g,t)}).enter().append("td").style("background",function(t){if((e=t).column==s&&""!==e.value)return function(t){{if("cohort_column"===l)return a[t.cohort](t.gradientValue);if("pivot_column"===l)return n[t.pivot](t.gradientValue)}return r(t.gradientValue)}(t);var e}).attr("class",function(t){return"float"==(e=$(t.column))||"integer"==e||"number"==e?"heatmap-number":"heatmap-string";var e}).text(function(t){return a=$((e=t).column),n=d3.format(","),r=d3.format("."+v+"%"),o=d3.time.format("%b %d, %Y"),""==e.value?e.value:"datetime"==a||"timestamp"==a||"date"==a?"function"==typeof moment?moment(e.value).utc().format("ll"):o(new Date(e.value)):e.column==u?n(e.value):e.column==s&&f?r(e.value):e.column==s?n(e.value):e.value;var e,a,n,r,o})},simpleHeatmap:function(t){var e=t.query_name,o=t.x_column,l=t.y_column,i=t.value_column,a=t.max_value||Number.MAX_VALUE,d=0===t.min_value?0:t.min_value||Number.MIN_VALUE,n=t.color_gradient||["#d73027","#f46d43","#fdae61","#fee08b","#ffffbf","#d9ef8b","#a6d96a","#66bd63","#1a9850"],r=t.html_element||"body",s=t.title||e,c=(t.x_label,t.y_label||""),u=t.value_is_percent,m=t.precision||0,h=alamode.getDataFromQuery(e),p=alamode.getColumnsFromQuery(e),f=_.uniq(_.map(h,o)),v=_.uniq(_.map(h,l)),g=alamode.addContainerElement(r),y=d3.scale.quantize().domain(d3.extent(h,function(t){return Math.max(d,Math.min(a,t[i]))})).range(n);d3.select(g).append("div").attr("class","mode-graphic-title").text(s),d3.select(g).append("div").attr("class","mode-simple-heatmap-label").text(c),headers=[o].concat(v);var x=d3.select(g).append("table").attr("class","mode-simple-heatmap-table");function b(e){return p.filter(function(t){return t.name==e})[0].type}x.selectAll(".mode-simple-heatmap-table-header").data([0]).enter().append("tr").attr("class","mode-simple-heatmap-table-header").selectAll("mode-simple-heatmap-table-header-cell").data(headers).enter().append("td").attr("class",function(t){return isNaN(t)?"mode-simple-heatmap-table-header-cell heatmap-string":"mode-simple-heatmap-table-header-cell heatmap-number"}).text(function(t){return t}),x.selectAll(".mode-simple-heatmap-table-row").data(f).enter().append("tr").attr("class","mode-simple-heatmap-table-row").selectAll(".mode-simple-heatmap-table-cell").data(function(t){return a=h,r=[{column:o,value:n=t}],v.forEach(function(e){var t=_.filter(a,function(t){return t[o]==n&&t[l]==e});entry=0<t.length?d3.mean(_.map(t,i)):d,r=r.concat({column:i,value:entry})}),r;var a,n,r}).enter().append("td").style("background",function(t){if(""!==(e=t).value&&e.column!=o&&e.column==i)return y(Math.max(d,Math.min(a,t.value)));var e}).attr("class",function(t){return"float"==(e=b(t.column))||"integer"==e||"number"==e?"heatmap-number":"heatmap-string";var e}).text(function(t){return a=b((e=t).column),n=d3.format(","),r=d3.format("."+m+"%"),o=d3.time.format("%b %d, %Y"),""==e.value?e.value:"datetime"==a||"timestamp"==a||"date"==a?"function"==typeof moment?moment(e.value).utc().format("ll"):o(new Date(e.value)):e.column==i&&u?r(e.value):e.column==i?n(e.value):e.value;var e,a,n,r,o})},heatmapOverlay:function(e){var n=datasets.filter(function(t){return t.query_token===e.queryToken}),r=[["#E2EFD6","#BCE0AF","#8CCF8A","#65BE76","#41AC6D","#1D9A6C","#158B5E","#0E7B50","#096A42"],["#D5F3D6","#AFE7BD","#89DAB0","#64CDAD","#40BEB4","#1D9AAF","#148C9E","#0D7D8C","#076D79"],["#D2EFFF","#A8DDFF","#7ECAFF","#54B5FF","#2A9EFF","#0086FF","#0079DF","#006BBF","#005C9F"]];function c(t,e){var a=Math.max(0,parseInt(t,10));return e?Math.floor(255*Math.min(100,a)/100):Math.min(255,a)}function o(t,e,a){var n="string"==typeof t?t:t.name,r=t.color_gradient;t.inverse&&(r=r.reverse());d3.mean(e.content.map(a));var o=d3.max(e.content.map(a)),l=d3.min(e.content.map(a)),i=d3.range(0,e.content.length),d=d3.scaleSequential().domain([l,o]).interpolator(d3.interpolateRgbBasis(r));console.log("buckets",i,e.content.map(a).sort());var s=d3.scaleThreshold().domain(i).range(e.content.map(a).sort());return{name:n,rules:i.map(function(t){return{type:"<=",value:s(t),color:(e=d(s(t)),n="",(a=/^rgb\(\s*(-?\d+)(%?)\s*,\s*(-?\d+)(%?)\s*,\s*(-?\d+)(%?)\s*\)$/.exec(e))&&(n="#"+(16777216+(c(a[1],a[2])<<16)+(c(a[3],a[4])<<8)+c(a[5],a[6])).toString(16).slice(1)),n)};var e,a,n}).concat({type:">=",value:o,color:r[r.length-1]})}}alamode.customizeTable([{vizId:e.vizId,formatByColumn:{columns:(e.columns||[]).map(function(t,e){if(!t)throw new Error("Colum data isn't passed properly.");var a="string"==typeof t?t:(t||{}).name;return o({name:a,color_gradient:t.color_gradient||r[e%r.length],inverse:t.inverse},n[0],function(t){return t[a]})})}}])},googleMap:function(t){var e=alamode.makeId(10),l=t.lat_column,i=t.lng_column,a=t.query_name,n=t.google_maps_api_key,r=t.title||a,d=t.label_column,o=t.html_element||"body",s=t.center_lat||39.5,c=t.center_lng||-98.35,u=t.starting_zoom||4,m=t.map_type||"terrain",h=t.height||600,p=alamode.getDataFromQuery(a),f=alamode.addContainerElement(o);d3.select(f).append("div").attr("class","mode-graphic-title").text(r),d3.select(f).append("div").attr("class","mode-google-map").attr("id",e).style("height",h+"px"),jQuery.getScript("https://maps.googleapis.com/maps/api/js?key="+n,function(){var t,o;t={zoom:u,center:new google.maps.LatLng(s,c),mapTypeId:m},o=new google.maps.Map(document.getElementById(e),t),p.forEach(function(t){var e=t[l],a=t[i];label=d?t[d]:"";var n=new google.maps.Marker({position:{lat:e,lng:a},map:o,title:label}),r=new google.maps.InfoWindow({content:label});n.addListener("click",function(){r.open(o,n)})})})},leafletMap:function(t){var e=alamode.makeId(10),a=t.lat_column,n=t.lng_column,r=t.query_name,o=t.title||r,l=t.height||400,i=t.html_element||"body",d=t.center_lat||39.5,s=t.center_lng||-98.35,c=t.starting_zoom||4,u=t.dot_size||.4,m=t.dot_opacity||.8,h=t.apply_filter||!1,p=alamode.getDataFromQuery(r),f=[];p.forEach(function(t){"number"==typeof t[a]&&"number"==typeof t[n]&&f.push(t)});var v=alamode.addContainerElement(i,h);d3.select(v).style("height",l+"px").append("div").attr("class","mode-graphic-title").text(o);var g=l-$(v+".mode-graphic-title").height(),y=$(v).width();d3.select(v).append("div").attr("class","mode-leaflet-map").attr("id",e).style("height",g+"px").style("width",y+"px");var x=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18}),_={max:8,data:f},b={lat:d,lng:s,zoom:c},w=new HeatmapOverlay({radius:u,maxOpacity:m,scaleRadius:!0,useLocalExtrema:!0,latField:a,lngField:n});new L.Map(e,{center:new L.LatLng(b.lat,b.lng),zoom:Math.floor(b.zoom),layers:[x,w]});w.setData(_)},wordCloud:function(t){var e=t.query_name,a=t.word_column,n=t.word_count_column,r=t.html_element||"body",o=t.title||e,l=t.height||"400",i=t.width||"800",d=t.colors||["black"],s=alamode.getDataFromQuery(e),c=alamode.addContainerElement(r);d3.select(c).append("div").attr("class","mode-graphic-title").text(o);var u=d3.scale.linear().domain(d3.extent(s,function(t){return t[n]})).range([12,60]),m=d3.layout.cloud().size([i,l]).words(s.map(function(t){return{text:t[a],size:u(t[n])}})).padding(2).rotate(function(){return 360*(~~(6*Math.random())-3)}).font("Impact").fontSize(function(t){return t.size}).on("end",function(t){d3.select(c).append("div").attr("class","mode-wordcloud").append("svg").attr("width",m.size()[0]).attr("height",m.size()[1]).append("g").attr("transform","translate("+m.size()[0]/2+","+m.size()[1]/2+")").selectAll("text").data(t).enter().append("text").style("font-size",function(t){return t.size+"px"}).style("font-family","Impact").style("fill",function(t,e){return d[e%d.length]}).attr("text-anchor","middle").attr("transform",function(t){return"translate("+[t.x,t.y]+")rotate("+t.rotate+")"}).text(function(t){return t.text})});m.start()},funnel:function(t){var e=alamode.makeId(10),a=t.query_name,n=t.stage_column,r=t.value_column,o=t.html_element||"body",l=t.title||a,i=t.height||"300",d=t.width||"500",s=alamode.getDataFromQuery(a),c=alamode.addContainerElement(o);d3.select(c).append("div").attr("class","mode-graphic-title").text(l),d3.select(c).append("div").attr("class","mode-funnel").attr("id",e).style("width",d+"px").style("height",i-20+"px");var u=[];s.forEach(function(t){u.push([t[n],t[r]])});new D3Funnel("#"+e).draw(u,{label:{format:"{l}: {f}"},block:{dynamicHeight:!0},chart:{bottomPinch:1},animation:100}),d3.select("#"+e).style("height",i+"px")},horizontalBarChart:function(r){var t=r.query_name,e=(r.bar_column,r.series_columns),o=r.colors||["#EE8D24","#43A5DA","#6AB328","#BB60F8","#E14459","#EAD022","#06D0AD","#DB38B7"];stacked=r.stacked||!1,leftpad=r.left_pad||175,htmlElement=r.html_element||"body",title=r.title||t,height=r.chart_height||395,width=r.width||"500";var l=alamode.getDataFromQuery(t),a=alamode.addContainerElement(htmlElement);d3.select(a).append("div").attr("class","mode-graphic-title").text(title),d3.select(a).append("div").attr("class","mode-horizontal-bar-chart").style("height",height-50+"px").append("svg");var i=[];e.forEach(function(e,t){var a={key:e,color:o[t%o.length]},n=[];l.forEach(function(t){n.push({label:t[r.bar_column],value:t[e]})}),a.values=n,i.push(a)}),nv.addGraph(function(){var t=nv.models.multiBarHorizontalChart().x(function(t){return t.label}).y(function(t){return t.value}).margin({top:30,right:20,bottom:50,left:leftpad}).showValues(!0).showControls(!1).stacked(stacked);return t.yAxis.tickFormat(d3.format(",.2f")),d3.select(a+" svg").datum(i).call(t),nv.utils.windowResize(t.update),t})},chartAnnotations:function(t){var w="#"+t.chart_id,n=t.x_axis_column,e=t.query_name,k=t.orientations,E=t.comment_values,r=t.group_by,a=t.comments,o=alamode.getDataFromQuery(e),C=[],l={};function i(){a.forEach(function(t,e){var a,n,r,o,l,i,d,s,c,u=C[e],m=k[e],h=E[e],p=d3.tip().attr("class","d3-tip").style("z-index",100).offset([-10,0]).html(function(t){return t}),f=$(w).find("g.nvd3.nv-wrap").attr("transform"),v=f.indexOf("("),g=f.indexOf(")"),x=f.indexOf(","),_=+f.slice(v+1,x),b=+f.slice(x+1,g);-1!=u&&"v"==m?(n=(a=$(w).find(".nv-point.nv-point-"+u).attr("transform")).indexOf("("),r=a.indexOf(")"),o=a.indexOf(","),l=+a.slice(n+1,o),i=+a.slice(o+1,r),$(w).find("g.nvd3.nv-wrap").first().find("rect").first().attr("height"),$(w).find("g.nvd3.nv-wrap").first().find("rect").first().attr("width"),(c=d3.select(w+" .nvd3svg")).call(p),c.append("rect").attr("x",l+_).attr("y",b-5).attr("width",1).attr("class","flag").attr("height",5+i).attr("fill","#ff8f53"),c.append("circle").data([t]).attr("cx",l+_).attr("cy",b-5).attr("class","flag").attr("r",5).attr("fill","#ff8f53").on("mouseover",p.show).on("mouseout",p.hide)):"h"!=m&&"h-left"!=m&&"h-right"!=m||(y="h"==m?"":"1",$(w).find("g.nv-y"+y+".nv-axis").find(".tick").each(function(t){lineLength="h-right"==m?+$(w).find("g.nv-y1.nv-axis").find(".tick").first().find("line").attr("x2"):+$(this).find("line").attr("x2"),tickTrans=$(this).attr("transform"),tickClosePos=tickTrans.indexOf(")"),tickCommaPos=tickTrans.indexOf(","),0==t?(yTrans1=+tickTrans.slice(tickCommaPos+1,tickClosePos),yVal1=+$(this).find("text").text().replace(",","")):1==t&&(yTrans2=+tickTrans.slice(tickCommaPos+1,tickClosePos),yVal2=+$(this).find("text").text().replace(",",""))}),d=(yTrans2-yTrans1)/(yVal2-yVal1),s=yTrans2-yVal2*d+h*d,(c=d3.select(w+" .nvd3svg")).call(p),c.append("rect").attr("x",_).attr("y",s+b).attr("width",lineLength+10).attr("height",1).attr("class","flag").attr("fill","#ff8f53"),c.append("circle").data([t]).attr("cx",lineLength+_+10).attr("cy",s+b).attr("class","flag").attr("r",5).attr("fill","#ff8f53").on("mouseover",p.show).on("mouseout",p.hide))})}r&&(l=_.groupBy(o,function(t){return t[r]})),a.forEach(function(t,e){var a=_.filter(o,function(t){return t[n]==E[e]});pointNumber=0!=a.length?r?l[a[0][r]].indexOf(a[0]):o.indexOf(a[0]):-1,C.push(pointNumber)}),setTimeout(function(){d3.select(w).selectAll(".flag").remove(),i()},1e3),$(window).resize(function(){d3.select(w).selectAll(".flag").remove(),s(function(){i()},500,"")});var d,s=(d={},function(t,e,a){d[a=a||"Don't call this twice without a uniqueId"]&&clearTimeout(d[a]),d[a]=setTimeout(t,e)})},bulletChart:function(l){var i=alamode.makeId(10),t=l.query_name,e=l.html_element||"body",a=l.title||t,d=l.chart_width||"800",s=l.bar_column||"",c=l.marker_column||"",u=l.left_pad||150,m=l.color,n=alamode.getDataFromQuery(t),r=alamode.addContainerElement(e);d3.select(r).append("div").attr("class","mode-graphic-title").text(a),d3.select(r).append("div").attr("class","mode-bullet-chart").style("width",d).attr("id",i),n.forEach(function(t){var e=t[l.title_column]||"",a=t[l.subtitle_column]||"",n=t[l.marker_column]||"",r=t[l.bar_column]||"";scale=l.scale_columns?[t[l.scale_columns[0]],t[l.scale_columns[1]],t[l.scale_columns[2]]]:l.scale_columns;var o={title:e,subtitle:a,ranges:scale,measures:[r],measureLabels:[s],markers:[n],markerLabels:[c],color:m};nv.addGraph(function(){var t=nv.models.bulletChart().height(50).width(d).margin({left:u,right:15,top:10,bottom:10});d3.select("#"+i).append("svg").style("width",d+"px").style("height","70px").style("display","inline").datum(o).transition().duration(500).call(t);return t})})},sunburstChart:function(t){var c=alamode.makeId(10),e=t.query_name,n=t.event_columns,r=t.event_counts,a=t.title||e,o=t.color_range||["#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00","#ffff33","#a65628","#f781bf","#999999"],l=t.html_element||"body",d=alamode.getDataFromQuery(e),s=850,u=Math.min(s,600)/2,m={w:(s-30)/n.length,h:20,s:3,t:10},h=[];n.forEach(function(t){h=h.concat(_.uniq(_.map(d,t)))});var p=_.uniq(h),f={};p.forEach(function(t,e){null!=t&&(f[t]=o[e%o.length])}),f.end="#666";var v=0,g=alamode.addContainerElement(l);d3.select(g).append("div").attr("class","mode-graphic-title").text(a),d3.select(g).append("div").attr("class","mode-sunburst-sequence").attr("id","sequence-"+c),d3.select(g).append("div").attr("class","mode-sunburst").attr("id",c),d3.select(g).append("div").attr("class","mode-sunburst-legend-container").attr("id","legend-container-"+c),vis=d3.select("#"+c).append("svg:svg").attr("width",s).attr("height",600).append("svg:g").attr("transform","translate("+s/2+",300)"),vis.append("text").attr("x",0).attr("y",-30).attr("text-anchor","middle").attr("class","mode-sunburst-explanation mode-sunburst-percentage").attr("id","percentage-"+c).style("visibility","hidden").text(""),vis.append("text").attr("x",0).attr("y",-10).attr("text-anchor","middle").attr("class","mode-sunburst-explanation").style("visibility","hidden").text("of total sequences."),vis.append("text").attr("x",0).attr("y",20).attr("text-anchor","middle").attr("class","mode-sunburst-explanation mode-sunburst-cond-percentage").attr("id","cond-percentage-"+c).style("visibility","hidden").text(""),vis.append("text").attr("x",0).attr("y",40).attr("text-anchor","middle").attr("class","mode-sunburst-explanation").style("visibility","hidden").text("from previous location.");var y=d3.layout.partition().size([2*Math.PI,u*u]).value(function(t){return t.size}),x=d3.svg.arc().startAngle(function(t){return t.x}).endAngle(function(t){return t.x+t.dx}).innerRadius(function(t){return Math.sqrt(t.y)}).outerRadius(function(t){return Math.sqrt(t.y+t.dy)}),b=[];function w(t){var e=(100*t.value/v).toPrecision(3),a=e+"%";e<.1&&(a="< 0.1%");var n=$(t),r=t.parent.value,o=(100*t.value/r).toPrecision(3),l=o+"%";o<1&&(a="< 1%"),d3.select("#cond-percentage-"+c).text(l),d3.select("#percentage-"+c).text(a),d3.selectAll(".mode-sunburst-explanation").style("visibility","");var i,d,s,n=$(t);i=n,d=d3.select("#trail-"+c).selectAll("g").data(i,function(t){return t.name+t.depth}),(s=d.enter().append("svg:g")).append("svg:polygon").attr("points",E).style("fill",function(t){return f[t.name]}),s.append("svg:text").attr("x",(m.w+m.t)/2).attr("y",m.h/2).attr("dy","0.35em").attr("text-anchor","middle").text(function(t){return t.name}),d.attr("transform",function(t,e){return 5<e&&e<10?"translate("+(e-=5)*(m.w+m.s)+", 20)":10<e?"translate("+(e-=11)*(m.w+m.s)+", 40)":"translate("+e*(m.w+m.s)+", 0)"}),d.exit().remove(),d3.select("#trail-"+c).style("visibility",""),d3.selectAll("path").style("opacity",.3),vis.selectAll("path").filter(function(t){return 0<=n.indexOf(t)}).style("opacity",1)}function k(t){d3.select("#trail-"+c).style("visibility","hidden"),d3.selectAll("path").on("mouseover",null),4==d3.version.split(".")[0]?d3.selectAll("path").transition().duration(300).style("opacity",1).on("end",function(){d3.select(this).on("mouseover",w)}):d3.selectAll("path").transition().duration(300).style("opacity",1).each("end",function(){d3.select(this).on("mouseover",w)}),d3.selectAll(".mode-sunburst-explanation").style("visibility","hidden")}function $(t){for(var e=[],a=t;a.parent;)e.unshift(a),a=a.parent;return e}function E(t,e){var a=[];return a.push("0,0"),a.push(m.w+",0"),a.push(m.w+m.t+","+m.h/2),a.push(m.w+","+m.h),a.push("0,"+m.h),0<e&&a.push(m.t+","+m.h/2),a.join(" ")}d.forEach(function(t){var e="";for(i=0;i<n.length;i++){if(prefix=0!=i?"-~-":"",null==t[n[i]]){e=e+prefix+"end";break}e=e+prefix+t[n[i]]}var a={0:e,1:t[r]};b.push(a)}),function(t){d3.select("#sequence-"+c).append("svg:svg").attr("width",s).attr("height",60).attr("id","trail-"+c).append("svg:text").attr("id","endlabel").style("fill","#000"),function(){var e=195,a=30,n=3;d3.entries(f).forEach(function(t){divContainer=d3.select("#legend-container-"+c).append("div").attr("class","mode-sunburst-legend").attr("id","legend-"+c),svg=divContainer.append("svg:svg").attr("width",e).attr("height",a),svg.append("svg:rect").attr("rx",n).attr("ry",n).attr("width",e).attr("height",a).style("fill",function(){return t.value}),svg.append("svg:text").attr("x",e/2).attr("y",a/2).attr("dy","0.35em").attr("text-anchor","middle").text(function(){return t.key})})}(),vis.append("svg:circle").attr("r",u).style("opacity",0);var e=y.nodes(t).filter(function(t){return.005<t.dx}),a=vis.data([t]).selectAll("path").data(e).enter().append("svg:path").attr("display",function(t){return t.depth?null:"none"}).attr("d",x).attr("fill-rule","evenodd").style("fill",function(t){return f[t.name]}).style("opacity",1).on("mouseover",w);vis.on("mouseleave",k),v=a.node().__data__.value}(function(t){for(var e,a={name:"root",children:[]},n=0;n<t.length;n++){var r=t[n][0],o=+t[n][1];if(!isNaN(o))for(var l=r.split("-~-"),i=a,d=0;d<l.length;d++){var s=i.children,c=l[d];if(d+1<l.length){for(var u=!1,m=0;m<s.length;m++)if(s[m].name==c){e=s[m],u=!0;break}u||(e={name:c,children:[]},s.push(e)),i=e}else e={name:c,size:o},s.push(e)}}return a}(b))},zipcodeChoropleth:function(t){var a=alamode.makeId(10),e=t.query_name,n=t.zipcode_column,r=t.value_column,o=t.width||950,l=t.height||o/1.9,i=t.title||e,d=t.color_range,s=t.color_gradient||["#FFF8CC","#FFF5B2","#FFF299","#E5D87F","#CCBF66","#B2A54C","#998C33","#7F7219","#665900"],c=t.html_element||"body",u=alamode.getDataFromQuery(e),m=d3.map(),h=d3.geoAlbersUsa().scale(o).translate([o/2,l/2]),p=d3.geoPath().projection(h),f=alamode.addContainerElement(c);d3.select(f).append("div").attr("class","mode-graphic-title").text(i),svg=d3.select(f).append("div").attr("class","mode-zipcode-chorolpleth").append("svg").attr("id","mode-zipcode-chorolpleth-"+a).attr("width",o).attr("height",l),u.forEach(function(t){m.set(t[n],+t[r])}),colorDomain=d||d3.extent(u,function(t){return t[r]});var v=d3.scale.quantize().domain(colorDomain).range(s);queue().defer(d3.json,"https://s3-us-west-2.amazonaws.com/mode-alamode/zips_us_topo.json").await(function(t,e){d3.select("#mode-zipcode-chorolpleth-"+a).append("g").attr("class","zipcodes").selectAll(".mode-zipcode-chorolpleth-zipcodes"+a).data(topojson.feature(e,e.objects.zip_codes_for_the_usa).features).enter().append("path").attr("class","mode-zipcode-chorolpleth-zipcodes-"+a).attr("fill",function(t){return v(m.get(t.properties.zip))}).attr("d",p)})},countyChoropleth:function(t){var a=alamode.makeId(10),e=t.query_name,n=t.county_id_column,r=t.value_column,o=t.width||950,l=t.height||o/1.9,i=t.title||e,d=t.color_range,s=t.color_gradient||["#f7fbff","#deebf7","#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#08519c","#08306b"],c=t.html_element||"body",u=alamode.getDataFromQuery(e),m=d3.map(),h=d3.geoAlbersUsa().scale(o).translate([o/2,l/2]),p=d3.geoPath().projection(h),f=alamode.addContainerElement(c);d3.select(f).append("div").attr("class","mode-graphic-title").text(i),svg=d3.select(f).append("div").attr("class","mode-county-chorolpleth").append("svg").attr("id","mode-county-chorolpleth-"+a).attr("width",o).attr("height",l),u.forEach(function(t){m.set(t[n],+t[r])}),colorDomain=d||d3.extent(u,function(t){return t[r]});var v=d3.scale.quantize().domain(colorDomain).range(s);queue().defer(d3.json,"https://s3-us-west-2.amazonaws.com/mode-alamode/counties.json").await(function(t,e){d3.select("#mode-county-chorolpleth-"+a).append("g").attr("class","mode-county-chorolpleth-counties").selectAll(".mode-county-chorolpleth-counties"+a).data(topojson.feature(e,e.objects.counties).features).enter().append("path").attr("class","mode-county-chorolpleth-counties-"+a).attr("fill",function(t){return v(m.get(t.id))}).attr("d",p),d3.select("#mode-county-chorolpleth-"+a).append("path").datum(topojson.mesh(e,e.objects.states,function(t,e){return t!==e})).attr("class","mode-county-chorolpleth-states").attr("d",p)})},stateChoropleth:function(t){var a=alamode.makeId(10),e=t.query_name,n=t.state_column,r=t.value_column,o=t.state_code_type,l=t.width||950,i=t.height||l/1.9,d=t.title||e,s=t.color_range,c=t.color_gradient||["#f7fbff","#deebf7","#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#08519c","#08306b"],u=t.html_element||"body",m=alamode.getDataFromQuery(e),h=d3.map(),p=d3.geoAlbersUsa().scale(l).translate([l/2,i/2]),f=d3.geoPath().projection(p),v=alamode.addContainerElement(u);d3.select(v).append("div").attr("class","mode-graphic-title").text(d),svg=d3.select(v).append("div").attr("class","mode-state-chorolpleth").append("svg").attr("id","mode-state-chorolpleth-"+a).attr("width",l).attr("height",i),m.forEach(function(t){h.set(t[n],+t[r])}),colorDomain=s||d3.extent(m,function(t){return t[r]});var g=d3.scale.quantize().domain(colorDomain).range(c);queue().defer(d3.json,"https://s3-us-west-2.amazonaws.com/mode-alamode/states.json").await(function(t,e){d3.select("#mode-state-chorolpleth-"+a).append("g").attr("class","mode-state-chorolpleth-states").selectAll(".mode-state-chorolpleth-states-"+a).data(e.features).enter().append("path").attr("class","mode-state-chorolpleth-states-"+a).attr("fill",function(t){return g(h.get(t.properties[o]))}).attr("d",f)})},worldChoropleth:function(t){var a=alamode.makeId(10),e=t.query_name,n=t.country_column,r=t.value_column,o=t.country_code_type,l=t.width||950,i=t.height||.8*l,d=t.title||e,s=t.color_range,c=t.color_gradient||["#9ecae1","#6baed6","#4292c6","#2171b5","#08519c","#08306b"],u=t.html_element||"body",m=alamode.getDataFromQuery(e),h=d3.map(),p=d3.geo.mercator().scale((l+1)/2/Math.PI).translate([l/2,i/2+.1*i]).precision(.1),f=d3.geoPath().projection(p),v=alamode.addContainerElement(u);d3.select(v).append("div").attr("class","mode-graphic-title").text(d),d3.select(v).append("div").attr("class","mode-world-chorolpleth-legend").attr("id","mode-world-chorolpleth-legend-"+a).text("Hover over a country to see details"),svg=d3.select(v).append("div").attr("class","mode-world-chorolpleth").append("svg").attr("id","mode-world-chorolpleth-"+a).attr("width",l).attr("height",i),m.forEach(function(t){h.set(t[n],+t[r])}),colorDomain=s||d3.extent(m,function(t){return t[r]});var g=d3.scale.quantize().domain(colorDomain).range(c);queue().defer(d3.json,"https://s3-us-west-2.amazonaws.com/mode-alamode/world.json").await(function(t,e){d3.select("#mode-world-chorolpleth-"+a).append("g").attr("class","mode-world-chorolpleth-countries-base").selectAll(".mode-world-chorolpleth-countries").data(topojson.feature(e,e.objects.countries).features).enter().append("path").attr("class","mode-world-chorolpleth-countries").attr("fill",function(t){return g(h.get(t.properties[o]))}).attr("d",f).on("mouseover",function(t){var e=t.properties.name;value=h.get(t.properties[o])?h.get(t.properties[o]):"--",d3.select("#mode-world-chorolpleth-legend-"+a).text(e+": "+value)}).on("mouseout",function(t){d3.select("#mode-world-chorolpleth-legend-"+a).text("Hover over a country to see details")}),d3.select("#mode-world-chorolpleth-"+a).append("path").datum(topojson.mesh(e,e.objects.countries,function(t,e){return t!==e})).attr("class","mode-world-chorolpleth-boundaries").attr("d",f)})},pivotTable:function(t){var e=alamode.makeId(10),a=t.query_name,n=t.default_columns,r=t.default_rows,o=t.default_values,l=t.editable,i=t.aggregate_function||"Count",d=t.pivot_table_type||"Table",s=t.default_column_value||a,c=t.html_element||"body",u=t.default_exclusions||[],m=t.default_inclusions||[];Array.isArray(o)||(o=[o]);var h=alamode.getDataFromQuery(a),p=alamode.getColumnsFromQuery(a),f=_.map(p,"name"),v=alamode.addContainerElement(c);d3.select(v).append("div").attr("class","mode-graphic-title").text(s),d3.select(v).append("div").attr("class","mode-pivot-table").attr("id",e);var g,y,x,b=[];b.push(f),h.forEach(function(e){var a=[];f.forEach(function(t){a.push(e[t])}),b.push(a)}),l?$("#"+e).pivotUI(b,{cols:n,rows:r,aggregatorName:i,vals:o,rendererName:d,exclusions:u,inclusions:m}):(y=(g=$.pivotUtilities).renderers[d],x=g.aggregators[i],$("#"+e).pivot(b,{cols:n,rows:r,aggregator:x(o),renderer:y,exclusions:u,inclusions:m}))},pieChartLabels:function(t){var e=t.show_all_labels,a=t.chart_id,n=$("#"+a),o={};setInterval(function(){var t,r;r=e,(t=n).find(".nv-legendWrap .nv-series text").each(function(a){var n=$(this).text();t.find(".nv-pieWrap .nv-pieLabels text").each(function(t){var e=a+"-"+t;text=$(this).text(),a==t&&""!=text&&text!=o[e]?text=n+" - "+text:a==t&&r&&text!=o[e]&&(text=n),o[e]=text,$(this).text(text)})})},300)},bigNumberSparkline:function(t){var e="#"+t.chart_id,a=t.x_axis_column,n=t.value_column,r=t.query_name,o=alamode.makeId(12),l=alamode.getDataFromQuery(r),i=alamode.getColumnsFromQuery(r);xType=a?(xMatch=_.filter(i,{name:a}),xMatch[0].type):"string";var d=[];l.forEach(function(t){formattedX="datetime"==xType||"timestamp"==xType||"date"==xType?d3.time.format.utc("%Y-%m-%d")(new Date(Date.parse(t[a]))):t[a];var e={x:formattedX,y:t[n]};d.push(e)});var s=$(e+" .chart-wrapper"),c=$(e+" .chart-big-number"),u=s.height(),m=s.width(),h=c.height(),p=u-h-20;d3.select(e+" .chart-big-number").append("svg").attr("height",p).attr("width",m).attr("id",o).append("g").attr("transform","translate(0,"+h+")"),nv.addGraph(function(){var t=nv.models.sparklinePlus().margin({left:15,right:15}).x(function(t,e){return e}).xTickFormat(function(t){return d[t].x}).showLastValue(!1);return d3.select("#"+o).datum(d).call(t),t}),setTimeout(function(){d3.selectAll(e+" path").style("stroke-width","2px").style("stroke-linejoin","round").style("stroke","#646C6C"),d3.selectAll(e+" .nv-minValue").style("fill","#EE7437").style("stroke","#EE7437").attr("r",3),d3.selectAll(e+" .nv-maxValue").style("fill","#37B067").style("stroke","#37B067").attr("r",3),d3.selectAll(e+" .nv-currentValue").style("fill","#22A3C0").style("stroke","#22A3C0").attr("r",3)},1e3)},addLinkToBigNumber:function(t){window.ALAMODE_CHARTS=window.ALAMODE_CHARTS||{};var e=t.chart_id.split("_")[1];window.ALAMODE_CHARTS[e]=t.url},forceDirectedGraph:function(t){var e=alamode.makeId(10),a=t.node_query,n=t.edge_query,r=t.html_element||"body",o=t.title||queryName,l=t.chart_width||"800",i=t.chart_height||"800",d=t.group_colors||"",s=t.links_to_show||100,c=alamode.getDataFromQuery(a),u=alamode.getDataFromQuery(n),m=[];u.forEach(function(e){var t=m.filter(function(t){return t.target==e.source}).filter(function(t){return t.source==e.target});0!=t.length?t.edge_size+=e.edge_size:m.push(e)}),m=(m=m.sort(function(t,e){return e.edge_size-t.edge_size})).slice(0,s),nameMap={},c.forEach(function(t,e){t.id=e,nameMap[t.node]=e}),m.forEach(function(t){t.source_id=nameMap[t.source],t.target_id=nameMap[t.target]});var h=alamode.addContainerElement(r);d3.select(h).append("div").attr("class","mode-graphic-title").text(o),d3.select(h).append("div").attr("class","mode-force-directed-graph").style("width",l).attr("id",e);var p=d3.tip().attr("class","mode-force-directed-graph-tooltip").offset([-10,0]).html(function(t){return t.node}),f=d3.layout.force().linkDistance(40).linkStrength(1).size([l,i]),v=d3.select("#"+e).append("svg").attr("width",l).attr("height",i);v.call(p);var g={nodes:c,links:m},y=d3.scale.linear().domain(d3.extent(c,function(t){return t.node_size})).range([2,20]),x=d3.scale.linear().domain(d3.extent(m,function(t){return t.edge_size})).range([1,10]),_=d3.scale.linear().domain(d3.extent(m,function(t){return t.edge_size})).range([.1,.9]),c=g.nodes.slice(),m=[],b=[];g.links.forEach(function(t){var e=c[t.source_id],a=c[t.target_id],n={};n.connections=t.edge_size,c.push(n),m.push({source:e,target:n},{source:n,target:a}),b.push([e,n,a])}),f.nodes(c).links(m).start();var w=v.selectAll(".mode-force-directed-graph-link ").data(b).enter().append("path").attr("class","mode-force-directed-graph-link").style("stroke-width",function(t){return x(t[1].connections)}).style("opacity",function(t){return _(t[1].connections)}),k=v.selectAll(".mode-force-directed-graph-node").data(g.nodes).enter().append("g").attr("class","mode-force-directed-graph-node").call(f.drag);k.append("circle").attr("r",function(t){return y(t.node_size)}).style("fill",function(t){return d?d[t.node_group]:"#0E819A"}).on("mouseover",p.show).on("mouseout",p.hide),f.on("tick",function(){w.attr("d",function(t){return"M"+t[0].x+","+t[0].y+"S"+t[1].x+","+t[1].y+" "+t[2].x+","+t[2].y}),k.attr("transform",function(t){return"translate("+t.x+","+t.y+")"})})},networkMatrix:function(t){var e=alamode.makeId(10),a=t.node_query,n=t.edge_query,r=t.html_element||"body",o=t.title||queryName,l=t.padding_for_names||"200",i=t.chart_width||"800",d=t.chart_height||"800",s=t.group_colors||"",c=t.left_label||"",u=t.top_label||"",m=l,h=10,p=10,f=l,v=alamode.getDataFromQuery(a),g=alamode.getDataFromQuery(n);nameMap={},v.forEach(function(t,e){t.id=e,nameMap[t.node]=e}),g.forEach(function(t){t.source_id=nameMap[t.source],t.target_id=nameMap[t.target]});var y=d3.scale.ordinal().rangeBands([0,i]),x=d3.scale.linear().domain(d3.extent(g,function(t){return t.edge_size})).clamp(!0),_=alamode.addContainerElement(r);d3.select(_).append("div").attr("class","mode-graphic-title").text(o),d3.select(_).append("div").attr("class","mode-network-matrix-order-picker").html('<p>Order: <select id="mode-network-matrix-order-picker-'+e+'"><option value="name">Name</option><option value="count">Frequency</option><option value="group">Group</option></select>'),d3.select(_).append("div").attr("class","mode-network-matrix").style("width",i).attr("id",e);var b=d3.tip().attr("class","mode-network-matrix-tooltip").offset([-10,0]).html(function(t){return t.z}),w=d3.select("#"+e).append("svg").attr("width",i+f+h).attr("height",d+m+p);w.call(b);var k=w.append("g").attr("transform","translate("+f+","+m+")");graph={nodes:v,links:g};var $=[],E=(v=graph.nodes).length;v.forEach(function(t,e){t.index=e,t.count=0,$[e]=d3.range(E).map(function(t){return{x:t,y:e,z:0}})}),graph.links.forEach(function(t){void 0!==$[t.source_id][t.target_id]?($[t.source_id][t.target_id].z+=t.edge_size,v[t.source_id].count+=t.edge_size,v[t.target_id].count+=t.edge_size):($[t.source_id][t.target_id]={},$[t.source_id][t.target_id].z=0)});var C,A={name:d3.range(E).sort(function(t,e){return d3.ascending(v[t].node,v[e].node)}),count:d3.range(E).sort(function(t,e){return v[e].count-v[t].count}),group:d3.range(E).sort(function(t,e){return d3.ascending(v[t].node_group,v[e].node_group)})};y.domain(A.name),w.append("text").attr("class","mode-network-matrix-axis-label").attr("x",(i+f+h)/2).attr("y",25).attr("text-anchor","middle").text(u),w.append("text").attr("class","mode-network-matrix-axis-label").attr("x",(d+m+p)/-2).attr("y",25).attr("transform","rotate(-90)").attr("text-anchor","middle").text(c),k.append("rect").attr("class","mode-network-matrix-background").attr("width",i).attr("height",d),(C=k.selectAll(".mode-network-matrix-row").data($).enter().append("g").attr("class","mode-network-matrix-row").attr("transform",function(t,e){return"translate(0,"+y(e)+")"}).each(C)).append("line").attr("class","mode-network-matrix-line").attr("x2",i),C.append("text").attr("class","mode-network-matrix-row-text").attr("x",-6).attr("y",y.rangeBand()/2).attr("dy",".32em").attr("text-anchor","end").text(function(t,e){return v[e].node});var F=k.selectAll(".mode-network-matrix-column").data($).enter().append("g").attr("class","mode-network-matrix-column").attr("transform",function(t,e){return"translate("+y(e)+")rotate(-90)"});function C(t){d3.select(this).selectAll(".mode-network-matrix-cell").data(t.filter(function(t){return t.z})).enter().append("rect").attr("class","mode-network-matrix-cell").attr("x",function(t){return y(t.x)}).attr("width",y.rangeBand()).attr("height",y.rangeBand()).style("fill-opacity",function(t){return x(t.z)}).style("fill",function(t){return v[t.x].node_group==v[t.y].node_group?s[v[t.x].node_group]:"#2B2B2B"}).on("mouseover",function(t){var a;a=t,d3.selectAll(".mode-network-matrix-row-text").classed("active",function(t,e){return e==a.y}),d3.selectAll(".mode-network-matrix-column-text").classed("active",function(t,e){return e==a.x}),b.show(t)}).on("mouseout",function(t){d3.selectAll("text").classed("active",!1),b.hide(t)})}F.append("line").attr("class","mode-network-matrix-line").attr("x1",-i),F.append("text").attr("class","mode-network-matrix-column-text").attr("x",6).attr("y",y.rangeBand()/2).attr("dy",".32em").attr("text-anchor","start").text(function(t,e){return v[e].node}),d3.select("#mode-network-matrix-order-picker-"+e).on("change",function(){!function(t){y.domain(A[t]);var e=k.transition().duration(1e3);e.selectAll(".mode-network-matrix-row").attr("transform",function(t,e){return"translate(0,"+y(e)+")"}).selectAll(".mode-network-matrix-cell").attr("x",function(t){return y(t.x)}),e.selectAll(".mode-network-matrix-column").attr("transform",function(t,e){return"translate("+y(e)+")rotate(-90)"})}(this.value)})},hive:function(t){d3.hive={},d3.hive.link=function(){function e(t,e){var a,n=i(d,this,t,e),r=i(s,this,t,e);n.a>r.a&&(a=r,r=n,n=a),r.a-n.a>Math.PI&&(n.a+=2*Math.PI);var o=n.a+(r.a-n.a)/3,l=r.a-(r.a-n.a)/3;return n.r0-n.r1||r.r0-r.r1?"M"+Math.cos(n.a)*n.r0+","+Math.sin(n.a)*n.r0+"L"+Math.cos(n.a)*n.r1+","+Math.sin(n.a)*n.r1+"C"+Math.cos(o)*n.r1+","+Math.sin(o)*n.r1+" "+Math.cos(l)*r.r1+","+Math.sin(l)*r.r1+" "+Math.cos(r.a)*r.r1+","+Math.sin(r.a)*r.r1+"L"+Math.cos(r.a)*r.r0+","+Math.sin(r.a)*r.r0+"C"+Math.cos(l)*r.r0+","+Math.sin(l)*r.r0+" "+Math.cos(o)*n.r0+","+Math.sin(o)*n.r0+" "+Math.cos(n.a)*n.r0+","+Math.sin(n.a)*n.r0:"M"+Math.cos(n.a)*n.r0+","+Math.sin(n.a)*n.r0+"C"+Math.cos(o)*n.r1+","+Math.sin(o)*n.r1+" "+Math.cos(l)*r.r1+","+Math.sin(l)*r.r1+" "+Math.cos(r.a)*r.r1+","+Math.sin(r.a)*r.r1}function i(t,e,a,n){var r=t.call(e,a,n),o=+("function"==typeof c?c.call(e,r,n):c)+h,l=+("function"==typeof u?u.call(e,r,n):u);return{r0:l,r1:u===m?l:+("function"==typeof m?m.call(e,r,n):m),a:o}}var d=function(t){return t.source},s=function(t){return t.target},c=function(t){return t.angle},u=function(t){return t.radius},m=u,h=-Math.PI/2;return e.source=function(t){return arguments.length?(d=t,e):d},e.target=function(t){return arguments.length?(s=t,e):s},e.angle=function(t){return arguments.length?(c=t,e):c},e.radius=function(t){return arguments.length?(u=m=t,e):u},e.startRadius=function(t){return arguments.length?(u=t,e):u},e.endRadius=function(t){return arguments.length?(m=t,e):m},e};var e=alamode.makeId(10),a=t.node_query,n=t.edge_query,r=t.groups_are_numeric,o=t.html_element||"body",l=t.title||queryName,i=t.chart_width||"800",d=t.chart_height||"800",s=t.group_colors||"",c=Math.min(i,d)/2-30,u=.2*c,m=alamode.getDataFromQuery(a),h=alamode.getDataFromQuery(n),p=_.uniq(_.map(m,"node_group")),f={};m.forEach(function(t){t.x=r?t.node_group:p.indexOf(t.node_group),t.y=t.node_size,f[t.node]=t}),h.forEach(function(t){t.source=f[t.source],t.target=f[t.target]});var v=alamode.addContainerElement(o);d3.select(v).append("div").attr("class","mode-graphic-title").text(l),d3.select(v).append("div").attr("class","mode-network-matrix").style("width",i).attr("id",e),angle=r?d3.scale.linear().domain(d3.extent(m,function(t){return t.node_group})).range([0,2*Math.PI]):d3.scale.ordinal().domain(d3.range(p.length+1)).rangePoints([0,2*Math.PI]);var g=d3.scale.linear().domain(d3.extent(m,function(t){return t.node_size})).range([u,c]),y=d3.tip().attr("class","mode-hive-tooltip").offset([-10,0]).html(function(t){return t.node}),x=d3.select("#"+e).append("svg").attr("width",i).attr("height",d).append("g").attr("transform","translate("+i/2+","+d/2+")");function b(t){return t/Math.PI*180-90}x.call(y),x.selectAll(".mode-hive-axis").data(d3.range(p.length)).enter().append("line").attr("class","mode-hive-axis").attr("transform",function(t){return"rotate("+b(angle(t))+")"}).attr("x1",g.range()[0]).attr("x2",g.range()[1]),x.selectAll(".mode-hive-link").data(h).enter().append("path").attr("class","mode-hive-link").attr("d",d3.hive.link().angle(function(t){return angle(t.x)}).radius(function(t){return g(t.y)})).style("stroke",function(t){return s[t.source.node_group]}),x.selectAll(".mode-hive-node").data(m).enter().append("circle").attr("class","mode-hive-node").attr("transform",function(t){return"rotate("+b(angle(t.x))+")"}).attr("cx",function(t){return g(t.y)}).attr("r",5).style("fill",function(t){return s[t.node_group]}).on("mouseover",function(e){y.show(e),d3.select(this).attr("class","mode-hive-node mode-hive-node-selected"),d3.selectAll(".mode-hive-link").data(h).attr("class",function(t){return t.source.node==e.node||t.target.node==e.node?"mode-hive-link-selected":"mode-hive-link"})}).on("mouseout",function(t){y.hide(t),d3.select(this).attr("class","mode-hive-node"),d3.selectAll(".mode-hive-link-selected").attr("class","mode-hive-link")})},conditionalFormattingByColumn:function(n){var v="#"+n.table_id,t=n.query_name,e=n.column_rules,g=alamode.getDataFromQuery(t),y=(alamode.getColumnsFromQuery(t),{});function a(t){var e,a=$(v+" table"),n=$(v+" .js-header-table"),r=n?$(v+" .js-col-header"):$(n).find("th");a.find("tr");r.each(function(){text=$(this).find(".axel-table-header-label").text(),e=$(this).attr("data-axel-column"),y[text]=e}),t.forEach(function(f){f.rules.forEach(function(t){var n,r,o,l,i,d,s,c,e,u,a,m,h,p=t.shade_text||!1;"gradient"==t.type?(c=f.column,e=t.color,u=p,a=d3.extent(_.map(g,c)),m=d3.scale.linear().domain(a).interpolate(d3.interpolateHsl).range(e),h=y[c],g.forEach(function(t,e){var a=v+" table [data-axel-rowkey='"+e+"'][data-axel-column='"+h+"']",n=m(t[c]),r=x(n),o=$(a);u?o.css("color",n):o.css({background:n,color:r})})):"above"!=t.type&&"below"!=t.type&&"equal"!=t.type||(n=f.column,r=t.type,o=t.value,l=t.color,i=p,d=y[n],s=x(l),g.forEach(function(t,e){var a=$(v+" table [data-axel-rowkey='"+e+"'][data-axel-column='"+d+"']");("above"==r&&t[n]>=o||"below"==r&&t[n]<=o||"equal"==r&&t[n]==o)&&(i?a.css("color",l):a.css({background:l,color:s}))}))})})}function x(t){var e,a=/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(t);return 125<(n=a?(rgb=(e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t))?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null,Math.round((299*parseInt(rgb.r)+587*parseInt(rgb.g)+114*parseInt(rgb.b))/1e3)):255)?"#2B2B2B":"#FCFCFC"}setTimeout(function(){a(e)},1e3),$(v).mousemove(function(){a(e)})},customizeTable:function(t){window.dispatchAction({type:"Embed.AlamodeCustomizeTable",payload:t})},conditionalFormattingByTable:function(n){var m="#"+n.table_id,t=n.query_name,h=n.columns;rules=n.rules;var p=alamode.getDataFromQuery(t),f=(alamode.getColumnsFromQuery(t),{}),a=[];h.forEach(function(t){var e=d3.extent(_.map(p,t));a=a.concat(e)});var v=d3.extent(a);function e(t){var e,a=$(m+" table"),n=$(m+" .js-header-table"),r=n?$(m+" .js-col-header"):$(n).find("th");a.find("tr");r.each(function(){text=$(this).find(".axel-table-header-label").text(),e=$(this).attr("data-axel-column"),f[text]=e}),t.forEach(function(t){var o,l,i,d,s,e,c,u,a=t.shade_text||!1;"gradient"==t.type?(e=t.color,c=a,u=d3.scale.linear().domain(v).interpolate(d3.interpolateHsl).range(e),p.forEach(function(l,i){h.forEach(function(t){var e=f[t],a=m+" table [data-axel-rowkey='"+i+"'][data-axel-column='"+e+"']",n=u(l[t]),r=g(n),o=$(a);c?o.css("color",n):o.css({background:n,color:r})})})):"above"!=t.type&&"below"!=t.type&&"equal"!=t.type||(o=t.type,l=t.value,i=t.color,d=a,s=g(i),p.forEach(function(n,r){h.forEach(function(t){var e=f[t],a=$(m+" table [data-axel-rowkey='"+r+"'][data-axel-column='"+e+"']");("above"==o&&n[t]>=l||"below"==o&&n[t]<=l||"equal"==o&&n[t]==l)&&(d?a.css("color",i):a.css({background:i,color:s}))})}))})}function g(t){var e,a=/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(t);return 125<(n=a?(rgb=(e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t))?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null,Math.round((299*parseInt(rgb.r)+587*parseInt(rgb.g)+114*parseInt(rgb.b))/1e3)):255)?"#2B2B2B":"#FCFCFC"}setTimeout(function(){e(rules)},1e3),$(m).mousemove(function(){e(rules)})},addTableOfContents:function(t){void 0===t&&(t="default");var e=t.text_color,a=t.background_color,n=t.hover_color;$(".mode-header").addClass("has-nav");var r=$("<nav class='fixed-nav-bar'></nav>");$(".row").each(function(){$(this).children().each(function(){var t,e,a=$(this).find("mode-chart").attr("id")||$(this).find("mode-table").attr("id")||$(this).find("mode-python").attr("id");if(!a)return!0;a.includes("chart")||a.includes("table")?(t=document.getElementById(a),e=0<$(t).find("mode-pivot-table").length?document.getElementById(a).getElementsByClassName("in-place-edit-text")[0].innerText:document.getElementById(a).getElementsByClassName("chart-title")[0].innerText):a.includes("python")&&(e=document.getElementById(a).getElementsByClassName("in-place-edit-text")[0].innerText);var n=$("<a class='scroll-link' href=#"+a+">"+(e.includes("Click to add title")?"Untitled":e)+"</a>");r.append(n)})});var o=$("<div class='mode-grid container''></div>");$(".mode-content").prepend(o);var l=$("<div class='row'></div>");o.prepend(l);var i=$("<div class='col-md-12'></div>");l.prepend(i),i.prepend(r),e&&$(".fixed-nav-bar a").css("color",e),a&&$(".fixed-nav-bar").css("background-color",a),n&&$(".fixed-nav-bar a").hover(function(){$(this).css("color",n)},function(){e?$(this).css("color",e):$(this).css("color","")}),setTimeout(function(){$(".scroll-link").on("click",function(t){t.preventDefault();var e,a,n=$(this).attr("href");e=750,a=$(n).offset().top-50,$("html,body").animate({scrollTop:a},e)})},100)},xAnnotations:function(t){var a=t.chart_id,r=t.comment_values,o=t.comments,l=t.color||[],d=t.is_date||!1;setTimeout(function(){var e=$("#"+a).find("div.highcharts-container")[0].id,t=Highcharts.charts;if(chart=t.filter(function(t){if(t)return t.container.id==e})[0],data=chart.series[0].data,d)for(i=0;i<r.length;i++)r[i]=new Date(r[i]).getTime();var n=data.filter(function(t){if(t)return 0<=r.indexOf(t.category)});chart.update({chart:{events:{load:function(t){for(i=0;i<n.length;i++){var e=n[i],a=l[i]||e.color||"#FCFCFC";t.renderer.label(o[i],e.plotX+t.plotLeft,10,"callout",e.plotX+t.plotLeft,e.plotY+t.plotTop).attr({fill:"#FCFCFC",stroke:a,"stroke-width":1,radius:10,zIndex:4}).add()}}(chart)}}})},250)}};