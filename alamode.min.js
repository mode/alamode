var version="0.20",alamode={reportError:function(e){$("<h1 class='mode-error'>").text(e).prependTo(document.body)},getColumnsFromQuery:function(e){var t=datasets.filter(function(t){if(t)return t.queryName==e})[0];return t?t.columns:(alamode.reportError("No such query: '"+e+"'"),[])},getDataFromQuery:function(e){var t=datasets.filter(function(t){if(t)return t.queryName==e})[0];return t?t.content:(alamode.reportError("No such query: '"+e+"'"),[])},makeId:function(e){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",n="";for(var r=0;r<e;r++)n+=t.charAt(Math.floor(Math.random()*t.length));return n},addContainerElement:function(e,t){return t=t||!1,id=alamode.makeId(10),e=="body"?$("<div id='"+id+"'></div>").addClass(id).addClass("mode-graphic-container").appendTo(".mode-content"):$(e).length===0?alamode.reportError("No such element: '"+e+"'"):(t&&$(e).empty(),$(e).addClass("mode-graphic-container"),$(e).addClass(id)),"."+id},addLinksToTables:function(e){function f(e){var n=$(t+" table"),r=$(t+" .js-header-table"),i=r?$(t+" .js-col-header"):$(r).find("th"),s=n.find("tr"),a=0;i.each(function(){text=$(this).find(".axel-table-header-label").text(),a=$(this).attr("data-axel-column"),o[text]=a-1}),s.each(function(t){if(t>0&&t<=u.length){var n=$(this).find("td"),r=n.first().attr("data-axel-rowkey");e.forEach(function(e){var t=o[e.column],i=n.eq(t).text();url=e.link_string;while(url.indexOf("{{")!=-1){var s=url.length,a=url.indexOf("{{"),f=url.substring(a+2,s).indexOf("}}"),l=url.substring(a+2,a+f+2),c=url.substring(a,a+f+4),h=o[l],p=u[r][l],d=encodeURIComponent(p);url=url.replace(c,d)}var v=$("<a>",{href:url}).text(i);n.eq(t).empty().append(v)})}})}var t="#"+e.table_id,n=e.link_columns,r=e.link_urls,i=e.query_name,s=[],o={};n.forEach(function(e,t){s.push({column:e,link_string:r[t]})});var u=alamode.getDataFromQuery(i),a=alamode.getColumnsFromQuery(i);setTimeout(function(){f(s)},1e3),$(t).mousemove(function(){f(s)})},customChartColors:function(e){function o(e,t){var n=$("#"+e),r=n.find(".nv-bar").length>0?n.find(".nv-group"):n.find(".nv-line").length>0||n.find(".nv-areaWrap").length>0?n.find(".nv-noninteractive"):n.find(".nv-pie .nv-slice"),s=r.length,o=n.find(".nv-series .nv-legend-symbol"),u={},a={},f={},l=0;if(o.length!=0||s>1)if(o.length==0&&s>1)for(i=0;i<s;i++)a[i]=i,u=t;else for(i=0;i<o.length;i++)u[i]=t[i%Object.keys(t).length];else a[0]=l,f[l]=0,u[0]=t[0];return o.each(function(e){$(this).css("fill-opacity")==1?(a[e]=l,f[l]=e,l+=1):a[e]=-1}),{chart:n,legend:o,colors:u,m:a,r:f,seriesCount:s}}function u(e,t){var n=o(e,t),i=n.chart,u=n.colors,a=n.m;for(var f in u)i.find(".nv-linesWrap .nv-groups .nv-series-"+a[f]).css({fill:u[f],stroke:u[f]}),i.find(".nv-barsWrap .nv-groups .nv-series-"+a[f]+" rect").css({fill:u[f],stroke:u[f]}),i.find(".nv-linePlusBar .nv-barsWrap .nv-bars rect").each(function(e){$(this).css({fill:u[0],stroke:u[0]})}),i.find(".nv-linePlusBar .nv-linesWrap .nv-groups .nv-series-0").css({fill:u[1],stroke:u[1]}),i.find(".nv-scatterWrap .nv-groups .nv-series-"+a[f]).css({fill:u[f],stroke:u[f]}),i.find(".nv-areaWrap .nv-area-"+a[f]).css({fill:u[f],stroke:u[f]}),i.find(".nv-pie .nv-slice").each(function(e){$(this).css({fill:u[e],stroke:u[e]})});for(var f in r)i.find(".nv-linesWrap .nv-groups .nv-series-"+a[f]).css({opacity:r[f]}),i.find(".nv-barsWrap .nv-groups .nv-series-"+a[f]+" rect").css({opacity:r[f]}),f==0&&(i.find(".nv-linePlusBar .nv-barsWrap .nv-bars rect").each(function(e){$(this).css({opacity:r[f]})}),i.find(".nv-linePlusBar .nv-linesWrap .nv-groups .nv-series-0").css({opacity:r[1]})),i.find(".nv-scatterWrap .nv-groups .nv-series-"+a[f]).css({opacity:r[f]}),i.find(".nv-areaWrap .nv-area-"+a[f]).css({opacity:r[f]}),i.find(".nv-pie .nv-slice").each(function(e){$(this).css({opacity:r[e]})});for(var f in s)i.find(".nv-linesWrap .nv-groups .nv-series-"+a[f]).css({"stroke-dasharray":s[f]});i.find(".nv-legendWrap .nv-series .nv-legend-symbol").each(function(e){$(this).css({fill:u[e],stroke:u[e]})})}function a(e,t){var n=$("#"+e);$(n).mousemove(function(){var r=o(e,t),i=r.legend,s=r.colors,u=r.r,a=r.m,f=r.seriesCount,l=isArea=n.find(".nv-area").length,c=n.find(".nv-bar").length,h=n.find(".nv-line").length;$("html").find(".nvtooltip table .legend-color-guide").each(function(e){if(i.length==0&&c==0)$(this).find("div").css({"background-color":s[a[e]]});else if(h>0&&c>0){var t=n.find(".nv-linePlusBar .nv-linesWrap .nv-groups .nv-series-0").css("fill"),r=n.find(".nv-linePlusBar .nv-barsWrap .nv-bars rect").css("fill");$(this).closest(".nvtooltip").find(".key")[0].innerText==""?$(this).find("div").css("background-color",r):$(this).find("div").css("background-color",t)}else c>0?f==1&&$(this).find("div").css({"background-color":s[u[f-e-1]]}):l>0?$(this).find("div").css({"background-color":s[l-e-1]}):$(this).find("div").css({"background-color":s[e]})});var p=n.find(".nv-pie .nv-slice.hover").css("fill");$("html").find(".nvtooltip table .legend-color-guide div").css("background-color",p)}),$(n).mouseleave(function(){$("html").find(".nvtooltip table .legend-color-guide").remove()})}var t=e.charts,n=e.colors,r=e.opacity,s=e.line_dashes;t=="all"&&(t=[],$("mode-chart").each(function(){t.push(this.id)})),setInterval(function(){t.forEach(function(e){u(e,n)})},500),t.forEach(function(e){a(e,n)})},addTotalsRow:function(e){function c(e){return numberColumns=_.map(_.filter(i,function(e){return["number","integer","float"].indexOf(e.type)!=-1}),"name"),e=="all"?numberColumns:_.intersection(e,numberColumns)}function h(e){var t=[];return i.forEach(function(n,r){if(e.indexOf(n.name)==-1)var i={idx:r,name:"",total:""};else var o=_.map(s,n.name),u=d3.sum(o),i={idx:r,name:n.name,total:u};t.push(i)}),t}function p(e){var t="<tr><td>TTL</td>";return e.forEach(function(e){e.total!=""?t=t+"<td class='cell-type-number'>"+a(e.total)+"</td>":t+="<td></td>"}),t+"</tr>"}var t=e.query_name,n=e.table_id||"",r="#"+n,i=alamode.getColumnsFromQuery(t),s=alamode.getDataFromQuery(t),o=e.columns_with_totals,u=e.fmt,a=u||d3.format(","),f=c(o),l=h(f);setTimeout(function(){r=="#"?(table=$(".main-table"),container=$(".js-table-content-container")):(table=$(r+" .main-table"),container=$(r+" .js-table-content-container"));var e=table.find("tr:last"),t=p(l),n=container.css("height"),i=+n.match(/\d+/)[0];e.after(t),container.css("height",i+26)},1e3)},addImagesToTables:function(e){function i(){var e=$(t+" table"),i=$(t+" .js-header-table"),s=i?$(t+" .js-col-header"):$(i).find("th"),o=e.find("tr"),u=0;s.each(function(){text=$(this).find(".axel-table-header-label").text(),text==n&&(u=+$(this).attr("data-axel-column"))}),o.each(function(){var e=$(this).find("td");e.each(function(e){if(e==u-1){var t=$(this).text();$(this).find("img").length==0&&($(this).css("text-align","center"),$(this).html("<img style='height: "+r+"px;' src='"+t+"'>"))}})})}var t="#"+e.table,n=e.column,r=e.image_height||100;setTimeout(function(){i()},1e3),$(t).keyup(function(){setTimeout(function(){i()},500)}),$(t).mousemove(function(){i()})},resizeChartHeight:function(e){var t=e.chart,n=e.height;t.slice(0,6)=="python"?($("#"+t+" .mode-python").css("height",n),$("#"+t+" .mode-python").css("max-height",n),$("#"+t+" img").css("max-height",n)):($("#"+t+" .chart").css("height",n),$("#"+t+" .chart-svg").css("height",n)),window.dispatchEvent(new Event("resize"))},retentionHeatmap:function(e){function b(e){return e.value==""?!1:e.column==r||e.column==o?!1:e.column==i?!0:!1}function w(e){var t=E(e.column);return t=="float"||t=="integer"||t=="number"?"heatmap-number":"heatmap-string"}function E(e){return p.filter(function(t){return t.name==e})[0].type}function S(e,t){var s=[{column:n,value:t}];if(o){var u=_.filter(e,function(e){return e[n]==t})[0],a={column:o,value:u[o]};s=s.concat(a)}return v.forEach(function(o){var u=_.filter(e,function(e){return e[n]==t&&e[r]==o});u.length>0?entry=d3.mean(_.map(u,i)):entry="",s=s.concat({column:i,value:entry})}),s}function x(e){var t=E(e.column),n=d3.format(","),r=d3.format("."+c+"%"),s=d3.time.format("%b %d, %Y");return e.value==""?e.value:t=="datetime"||t=="timestamp"||t=="date"?typeof moment=="function"?moment(e.value).utc().format("ll"):s(new Date(e.value)):e.column==o?n(e.value):e.column==i&&l?r(e.value):e.column==i?n(e.value):e.value}var t=e.query_name,n=e.cohort_column,r=e.pivot_column,i=e.value_column,s=e.color_gradient||["#d73027","#f46d43","#fdae61","#fee08b","#ffffbf","#d9ef8b","#a6d96a","#66bd63","#1a9850"],o=e.total_column,u=e.html_element||"body",a=e.title||t,f=e.pivot_label||"",l=e.value_is_percent,c=e.precision||0,h=alamode.getDataFromQuery(t),p=alamode.getColumnsFromQuery(t),d=_.uniq(_.map(h,n)),v=_.uniq(_.map(h,r)),m=alamode.addContainerElement(u),g=d3.scale.quantize().domain(d3.extent(h,function(e){return e[i]})).range(s);d3.select(m).append("div").attr("class","mode-graphic-title").text(a),d3.select(m).append("div").attr("class","mode-retention-heatmap-label").text(f),o?headers=[n,o].concat(v):headers=[n].concat(v);var y=d3.select(m).append("table").attr("class","mode-retention-heatmap-table");y.selectAll(".mode-retention-heatmap-table-header").data([0]).enter().append("tr").attr("class","mode-retention-heatmap-table-header").selectAll("mode-retention-heatmap-table-header-cell").data(headers).enter().append("td").attr("class",function(e){return isNaN(e)?"mode-retention-heatmap-table-header-cell heatmap-string":"mode-retention-heatmap-table-header-cell heatmap-number"}).text(function(e){return e}),y.selectAll(".mode-retention-heatmap-table-row").data(d).enter().append("tr").attr("class","mode-retention-heatmap-table-row").selectAll(".mode-retention-heatmap-table-cell").data(function(e){return S(h,e)}).enter().append("td").style("background",function(e){if(b(e))return g(e.value)}).attr("class",function(e){return w(e)}).text(function(t){return x(t,e)})},googleMap:function(e){var t=alamode.makeId(10),n=e.lat_column,r=e.lng_column,i=e.query_name,s=e.google_maps_api_key,o=e.title||i,u=e.label_column,a=e.html_element||"body",f=e.center_lat||39.5,l=e.center_lng||-98.35,c=e.starting_zoom||4,h=e.map_type||"terrain",p=e.height||600,d=alamode.getDataFromQuery(i),v=alamode.addContainerElement(a);d3.select(v).append("div").attr("class","mode-graphic-title").text(o),d3.select(v).append("div").attr("class","mode-google-map").attr("id",t).style("height",p+"px"),jQuery.getScript("https://maps.googleapis.com/maps/api/js?key="+s,function(){function e(){var e={zoom:c,center:new google.maps.LatLng(f,l),mapTypeId:h},i=new google.maps.Map(document.getElementById(t),e);d.forEach(function(e){var t=e[n],s=e[r];u?label=e[u]:label="";var o=new google.maps.Marker({position:{lat:t,lng:s},map:i,title:label}),a=new google.maps.InfoWindow({content:label});o.addListener("click",function(){a.open(i,o)})})}e()})},leafletMap:function(e){var t=alamode.makeId(10),n=e.lat_column,r=e.lng_column,i=e.query_name,s=e.title||i,o=e.height||400,u=e.html_element||"body",a=e.center_lat||39.5,f=e.center_lng||-98.35,l=e.starting_zoom||4,c=e.dot_size||.4,h=e.dot_opacity||.8,p=e.apply_filter||!1,d=alamode.getDataFromQuery(i),v=[];d.forEach(function(e){typeof e[n]=="number"&&typeof e[r]=="number"&&v.push(e)});var m=alamode.addContainerElement(u,p);d3.select(m).style("height",o+"px").append("div").attr("class","mode-graphic-title").text(s);var g=o-$(m+".mode-graphic-title").height(),y=$(m).width();d3.select(m).append("div").attr("class","mode-leaflet-map").attr("id",t).style("height",g+"px").style("width",y+"px");var b=L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18}),w={max:8,data:v},E={radius:c,maxOpacity:h,scaleRadius:!0,useLocalExtrema:!0,latField:n,lngField:r},S={lat:a,lng:f,zoom:l},x=new HeatmapOverlay(E),T=new L.Map(t,{center:new L.LatLng(S.lat,S.lng),zoom:Math.floor(S.zoom),layers:[b,x]});x.setData(w)},wordCloud:function(e){function p(e){d3.select(l).append("div").attr("class","mode-wordcloud").append("svg").attr("width",h.size()[0]).attr("height",h.size()[1]).append("g").attr("transform","translate("+h.size()[0]/2+","+h.size()[1]/2+")").selectAll("text").data(e).enter().append("text").style("font-size",function(e){return e.size+"px"}).style("font-family","Impact").style("fill",function(e,t){return a[t%a.length]}).attr("text-anchor","middle").attr("transform",function(e){return"translate("+[e.x,e.y]+")rotate("+e.rotate+")"}).text(function(e){return e.text})}var t=e.query_name,n=e.word_column,r=e.word_count_column,i=e.html_element||"body",s=e.title||t,o=e.height||"400",u=e.width||"800",a=e.colors||["black"],f=alamode.getDataFromQuery(t),l=alamode.addContainerElement(i);d3.select(l).append("div").attr("class","mode-graphic-title").text(s);var c=d3.scale.linear().domain(d3.extent(f,function(e){return e[r]})).range([12,60]),h=d3.layout.cloud().size([u,o]).words(f.map(function(e){return{text:e[n],size:c(e[r])}})).padding(2).rotate(function(){return(~~(Math.random()*6)-3)*360}).font("Impact").fontSize(function(e){return e.size}).on("end",p);h.start()},funnel:function(e){var t=alamode.makeId(10),n=e.query_name,r=e.stage_column,i=e.value_column,s=e.html_element||"body",o=e.title||n,u=e.height||"300",a=e.width||"500",f=alamode.getDataFromQuery(n),l=alamode.addContainerElement(s);d3.select(l).append("div").attr("class","mode-graphic-title").text(o),d3.select(l).append("div").attr("class","mode-funnel").attr("id",t).style("width",a+"px").style("height",u-20+"px");var c=[];f.forEach(function(e){c.push([e[r],e[i]])});var h={label:{format:"{l}: {f}"},block:{dynamicHeight:!0},chart:{bottomPinch:1},animation:100},p=new D3Funnel("#"+t);p.draw(c,h),d3.select("#"+t).style("height",u+"px")},horizontalBarChart:function(e){var t=e.query_name,n=e.bar_column,r=e.series_columns,i=e.colors||["#EE8D24","#43A5DA","#6AB328","#BB60F8","#E14459","#EAD022","#06D0AD","#DB38B7"];stacked=e.stacked||!1,leftpad=e.left_pad||175,htmlElement=e.html_element||"body",title=e.title||t,height=e.chart_height||395,width=e.width||"500";var s=alamode.getDataFromQuery(t),o=alamode.addContainerElement(htmlElement);d3.select(o).append("div").attr("class","mode-graphic-title").text(title),d3.select(o).append("div").attr("class","mode-horizontal-bar-chart").style("height",height-50+"px").append("svg");var u=[];r.forEach(function(t,n){var r={key:t,color:i[n%i.length]},o=[];s.forEach(function(n){o.push({label:n[e.bar_column],value:n[t]})}),r.values=o,u.push(r)}),nv.addGraph(function(){var e=nv.models.multiBarHorizontalChart().x(function(e){return e.label}).y(function(e){return e.value}).margin({top:30,right:20,bottom:50,left:leftpad}).showValues(!0).showControls(!1).stacked(stacked);return e.yAxis.tickFormat(d3.format(",.2f")),d3.select(o+" svg").datum(u).call(e),nv.utils.windowResize(e.update),e})},chartAnnotations:function(e){function c(){u.forEach(function(e,n){var r=f[n],o=i[n],u=s[n],a=d3.tip().attr("class","d3-tip").style("z-index",100).offset([-10,0]).html(function(e){return e}),l=$(t).find("g.nvd3.nv-wrap").attr("transform"),c=l.indexOf("("),h=l.indexOf(")"),p=l.indexOf(","),d=+l.slice(c+1,p),v=+l.slice(p+1,h);if(r!=-1&&o=="v"){var m=$(t).find(".nv-point.nv-point-"+r).attr("transform"),g=m.indexOf("("),b=m.indexOf(")"),w=m.indexOf(","),E=+m.slice(g+1,w),S=+m.slice(w+1,b),x=$(t).find("g.nvd3.nv-wrap").first().find("rect").first().attr("height"),T=$(t).find("g.nvd3.nv-wrap").first().find("rect").first().attr("width"),N=d3.select(t+" .nvd3svg");N.call(a),N.append("rect").attr("x",E+d).attr("y",v-5).attr("width",1).attr("class","flag").attr("height",S+5).attr("fill","#ff8f53"),N.append("circle").data([e]).attr("cx",E+d).attr("cy",v-5).attr("class","flag").attr("r",5).attr("fill","#ff8f53").on("mouseover",a.show).on("mouseout",a.hide)}else if(o=="h"||o=="h-left"||o=="h-right"){o=="h"?y="":y="1";var C=$(t).find("g.nv-y"+y+".nv-axis").find(".tick");C.each(function(e){o=="h-right"?lineLength=+$(t).find("g.nv-y1.nv-axis").find(".tick").first().find("line").attr("x2"):lineLength=+$(this).find("line").attr("x2"),tickTrans=$(this).attr("transform"),tickClosePos=tickTrans.indexOf(")"),tickCommaPos=tickTrans.indexOf(","),e==0?(yTrans1=+tickTrans.slice(tickCommaPos+1,tickClosePos),yVal1=+$(this).find("text").text().replace(",","")):e==1&&(yTrans2=+tickTrans.slice(tickCommaPos+1,tickClosePos),yVal2=+$(this).find("text").text().replace(",",""))});var k=(yTrans2-yTrans1)/(yVal2-yVal1),L=yTrans2-yVal2*k,A=L+u*k,N=d3.select(t+" .nvd3svg");N.call(a),N.append("rect").attr("x",d).attr("y",A+v).attr("width",lineLength+10).attr("height",1).attr("class","flag").attr("fill","#ff8f53"),N.append("circle").data([e]).attr("cx",lineLength+d+10).attr("cy",A+v).attr("class","flag").attr("r",5).attr("fill","#ff8f53").on("mouseover",a.show).on("mouseout",a.hide)}})}var t="#"+e.chart_id,n=e.x_axis_column,r=e.query_name,i=e.orientations,s=e.comment_values,o=e.group_by,u=e.comments,a=alamode.getDataFromQuery(r),f=[],l={};o&&(l=_.groupBy(a,function(e){return e[o]})),u.forEach(function(e,t){var r=_.filter(a,function(e){return e[n]==s[t]});r.length!=0?o?pointNumber=l[r[0][o]].indexOf(r[0]):pointNumber=a.indexOf(r[0]):pointNumber=-1,f.push(pointNumber)}),setTimeout(function(){d3.select(t).selectAll(".flag").remove(),c()},1e3),$(window).resize(function(){d3.select(t).selectAll(".flag").remove(),h(function(){c()},500,"")});var h=function(){var e={};return function(t,n,r){r||(r="Don't call this twice without a uniqueId"),e[r]&&clearTimeout(e[r]),e[r]=setTimeout(t,n)}}()},bulletChart:function(e){var t=alamode.makeId(10),n=e.query_name,r=e.html_element||"body",i=e.title||n,s=e.chart_width||"800",o=e.bar_column||"",u=e.marker_column||"",a=e.left_pad||150,f=e.color,l=alamode.getDataFromQuery(n),c=alamode.addContainerElement(r);d3.select(c).append("div").attr("class","mode-graphic-title").text(i),d3.select(c).append("div").attr("class","mode-bullet-chart").style("width",s).attr("id",t),l.forEach(function(n){var r=n[e.title_column]||"",i=n[e.subtitle_column]||"",l=n[e.marker_column]||"",c=n[e.bar_column]||"";e.scale_columns?scale=[n[e.scale_columns[0]],n[e.scale_columns[1]],n[e.scale_columns[2]]]:scale=e.scale_columns;var h={title:r,subtitle:i,ranges:scale,measures:[c],measureLabels:[o],markers:[l],markerLabels:[u],color:f};nv.addGraph(function(){var e=nv.models.bulletChart().height(50).width(s).margin({left:a,right:15,top:10,bottom:10}),n=d3.select("#"+t).append("svg").style("width",s+"px").style("height","70px").style("display","inline").datum(h).transition().duration(500).call(e);return e})})},sunburstChart:function(e){function T(e){L(),M(),vis.append("svg:circle").attr("r",h).style("opacity",0);var t=w.nodes(e).filter(function(e){return e.dx>.005}),n=vis.data([e]).selectAll("path").data(t).enter().append("svg:path").attr("display",function(e){return e.depth?null:"none"}).attr("d",E).attr("fill-rule","evenodd").style("fill",function(e){return g[e.name]}).style("opacity",1).on("mouseover",N);vis.on("mouseleave",C),y=n.node().__data__.value}function N(e){var n=(100*e.value/y).toPrecision(3),r=n+"%";n<.1&&(r="< 0.1%");var i=k(e),s=e.parent.value,o=(100*e.value/s).toPrecision(3),u=o+"%";o<1&&(r="< 1%"),d3.select("#cond-percentage-"+t).text(u),d3.select("#percentage-"+t).text(r),d3.selectAll(".mode-sunburst-explanation").style("visibility","");var i=k(e);O(i,r),d3.selectAll("path").style("opacity",.3),vis.selectAll("path").filter(function(e){return i.indexOf(e)>=0}).style("opacity",1)}function C(e){d3.select("#trail-"+t).style("visibility","hidden"),d3.selectAll("path").on("mouseover",null),d3.version.split(".")[0]==4?d3.selectAll("path").transition().duration(300).style("opacity",1).on("end",function(){d3.select(this).on("mouseover",N)}):d3.selectAll("path").transition().duration(300).style("opacity",1).each("end",function(){d3.select(this).on("mouseover",N)}),d3.selectAll(".mode-sunburst-explanation").style("visibility","hidden")}function k(e){var t=[],n=e;while(n.parent)t.unshift(n),n=n.parent;return t}function L(){var e=d3.select("#sequence-"+t).append("svg:svg").attr("width",c).attr("height",60).attr("id","trail-"+t);e.append("svg:text").attr("id","endlabel").style("fill","#000")}function A(e,t){var n=[];return n.push("0,0"),n.push(d.w+",0"),n.push(d.w+d.t+","+d.h/2),n.push(d.w+","+d.h),n.push("0,"+d.h),t>0&&n.push(d.t+","+d.h/2),n.join(" ")}function O(e,n){var r=d3.select("#trail-"+t).selectAll("g").data(e,function(e){return e.name+e.depth}),i=r.enter().append("svg:g");i.append("svg:polygon").attr("points",A).style("fill",function(e){return g[e.name]}),i.append("svg:text").attr("x",(d.w+d.t)/2).attr("y",d.h/2).attr("dy","0.35em").attr("text-anchor","middle").text(function(e){return e.name}),r.attr("transform",function(e,t){return t>5&&t<10?(t-=5,"translate("+t*(d.w+d.s)+", 20)"):t>10?(t-=11,"translate("+t*(d.w+d.s)+", 40)"):"translate("+t*(d.w+d.s)+", 0)"}),r.exit().remove(),d3.select("#trail-"+t).style("visibility","")}function M(){var e={w:195,h:30,s:3,r:3};d3.entries(g).forEach(function(n){divContainer=d3.select("#legend-container-"+t).append("div").attr("class","mode-sunburst-legend").attr("id","legend-"+t),svg=divContainer.append("svg:svg").attr("width",e.w).attr("height",e.h),svg.append("svg:rect").attr("rx",e.r).attr("ry",e.r).attr("width",e.w).attr("height",e.h).style("fill",function(){return n.value}),svg.append("svg:text").attr("x",e.w/2).attr("y",e.h/2).attr("dy","0.35em").attr("text-anchor","middle").text(function(){return n.key})})}function D(e){var t={name:"root",children:[]};for(var n=0;n<e.length;n++){var r=e[n][0],i=+e[n][1];if(isNaN(i))continue;var s=r.split("-~-"),o=t;for(var u=0;u<s.length;u++){var a=o.children,f=s[u],l;if(u+1<s.length){var c=!1;for(var h=0;h<a.length;h++)if(a[h]["name"]==f){l=a[h],c=!0;break}c||(l={name:f,children:[]},a.push(l)),o=l}else l={name:f,size:i},a.push(l)}}return t}var t=alamode.makeId(10),n=e.query_name,r=e.event_columns,s=e.event_counts,o=e.title||n,u=e.color_range||["#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00","#ffff33","#a65628","#f781bf","#999999"],a=e.html_element||"body",f=alamode.getDataFromQuery(n),l=600,c=850,h=Math.min(c,l)/2,p=(c-30)/r.length,d={w:p,h:20,s:3,t:10},v=[];r.forEach(function(e){v=v.concat(_.uniq(_.map(f,e)))});var m=_.uniq(v),g={};m.forEach(function(e,t){e!=null&&(g[e]=u[t%u.length])}),g.end="#666";var y=0,b=alamode.addContainerElement(a);d3.select(b).append("div").attr("class","mode-graphic-title").text(o),d3.select(b).append("div").attr("class","mode-sunburst-sequence").attr("id","sequence-"+t),d3.select(b).append("div").attr("class","mode-sunburst").attr("id",t),d3.select(b).append("div").attr("class","mode-sunburst-legend-container").attr("id","legend-container-"+t),vis=d3.select("#"+t).append("svg:svg").attr("width",c).attr("height",l).append("svg:g").attr("transform","translate("+c/2+","+l/2+")"),vis.append("text").attr("x",0).attr("y",-30).attr("text-anchor","middle").attr("class","mode-sunburst-explanation mode-sunburst-percentage").attr("id","percentage-"+t).style("visibility","hidden").text(""),vis.append("text").attr("x",0).attr("y",-10).attr("text-anchor","middle").attr("class","mode-sunburst-explanation").style("visibility","hidden").text("of total sequences."),vis.append("text").attr("x",0).attr("y",20).attr("text-anchor","middle").attr("class","mode-sunburst-explanation mode-sunburst-cond-percentage").attr("id","cond-percentage-"+t).style("visibility","hidden").text(""),vis.append("text").attr("x",0).attr("y",40).attr("text-anchor","middle").attr("class","mode-sunburst-explanation").style("visibility","hidden").text("from previous location.");var w=d3.layout.partition().size([2*Math.PI,h*h]).value(function(e){return e.size}),E=d3.svg.arc().startAngle(function(e){return e.x}).endAngle(function(e){return e.x+e.dx}).innerRadius(function(e){return Math.sqrt(e.y)}).outerRadius(function(e){return Math.sqrt(e.y+e.dy)}),S=[];f.forEach(function(e){var t="";for(i=0;i<r.length;i++){i!=0?prefix="-~-":prefix="";if(e[r[i]]==null){t=t+prefix+"end";break}t=t+prefix+e[r[i]]}var n={0:t,1:e[s]};S.push(n)});var x=D(S);T(x)},zipcodeChoropleth:function(e){function g(e,n){d3.select("#mode-zipcode-chorolpleth-"+t).append("g").attr("class","zipcodes").selectAll(".mode-zipcode-chorolpleth-zipcodes"+t).data(topojson.feature(n,n.objects.zip_codes_for_the_usa).features).enter().append("path").attr("class","mode-zipcode-chorolpleth-zipcodes-"+t).attr("fill",function(e){return m(h.get(e.properties.zip))}).attr("d",d)}var t=alamode.makeId(10),n=e.query_name,r=e.zipcode_column,i=e.value_column,s=e.width||950,o=e.height||s/1.9,u=e.title||n,a=e.color_range,f=e.color_gradient||["#FFF8CC","#FFF5B2","#FFF299","#E5D87F","#CCBF66","#B2A54C","#998C33","#7F7219","#665900"],l=e.html_element||"body",c=alamode.getDataFromQuery(n),h=d3.map(),p=d3.geoAlbersUsa().scale(s).translate([s/2,o/2]),d=d3.geoPath().projection(p),v=alamode.addContainerElement(l);d3.select(v).append("div").attr("class","mode-graphic-title").text(u),svg=d3.select(v).append("div").attr("class","mode-zipcode-chorolpleth").append("svg").attr("id","mode-zipcode-chorolpleth-"+t).attr("width",s).attr("height",o),c.forEach(function(e){h.set(e[r],+e[i])}),a?colorDomain=a:colorDomain=d3.extent(c,function(e){return e[i]});var m=d3.scale.quantize().domain(colorDomain).range(f);queue().defer(d3.json,"https://s3-us-west-2.amazonaws.com/mode-alamode/zips_us_topo.json").await(g)},countyChoropleth:function(e){function g(e,n){d3.select("#mode-county-chorolpleth-"+t).append("g").attr("class","mode-county-chorolpleth-counties").selectAll(".mode-county-chorolpleth-counties"+t).data(topojson.feature(n,n.objects.counties).features).enter().append("path").attr("class","mode-county-chorolpleth-counties-"+t).attr("fill",function(e){return m(h.get(e.id))}).attr("d",d),d3.select("#mode-county-chorolpleth-"+t).append("path").datum(topojson.mesh(n,n.objects.states,function(e,t){return e!==t})).attr("class","mode-county-chorolpleth-states").attr("d",d)}var t=alamode.makeId(10),n=e.query_name,r=e.county_id_column,i=e.value_column,s=e.width||950,o=e.height||s/1.9,u=e.title||n,a=e.color_range,f=e.color_gradient||["#f7fbff","#deebf7","#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#08519c","#08306b"],l=e.html_element||"body",c=alamode.getDataFromQuery(n),h=d3.map(),p=d3.geoAlbersUsa().scale(s).translate([s/2,o/2]),d=d3.geoPath().projection(p),v=alamode.addContainerElement(l);d3.select(v).append("div").attr("class","mode-graphic-title").text(u),svg=d3.select(v).append("div").attr("class","mode-county-chorolpleth").append("svg").attr("id","mode-county-chorolpleth-"+t).attr("width",s).attr("height",o),c.forEach(function(e){h.set(e[r],+e[i])}),a?colorDomain=a:colorDomain=d3.extent(c,function(e){return e[i]});var m=d3.scale.quantize().domain(colorDomain).range(f);queue().defer(d3.json,"https://s3-us-west-2.amazonaws.com/mode-alamode/counties.json").await(g)},stateChoropleth:function(e){function y(e,n){d3.select("#mode-state-chorolpleth-"+t).append("g").attr("class","mode-state-chorolpleth-states").selectAll(".mode-state-chorolpleth-states-"+t).data(n.features).enter().append("path").attr("class","mode-state-chorolpleth-states-"+t).attr("fill",function(e){return g(p.get(e.properties[s]))}).attr("d",v)}var t=alamode.makeId(10),n=e.query_name,r=e.state_column,i=e.value_column,s=e.state_code_type,o=e.width||950,u=e.height||o/1.9,a=e.title||n,f=e.color_range,l=e.color_gradient||["#f7fbff","#deebf7","#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#08519c","#08306b"],c=e.html_element||"body",h=alamode.getDataFromQuery(n),p=d3.map(),d=d3.geoAlbersUsa().scale(o).translate([o/2,u/2]),v=d3.geoPath().projection(d),m=alamode.addContainerElement(c);d3.select(m).append("div").attr("class","mode-graphic-title").text(a),svg=d3.select(m).append("div").attr("class","mode-state-chorolpleth").append("svg").attr("id","mode-state-chorolpleth-"+t).attr("width",o).attr("height",u),h.forEach(function(e){p.set(e[r],+e[i])}),f?colorDomain=f:colorDomain=d3.extent(h,function(e){return e[i]});var g=d3.scale.quantize().domain(colorDomain).range(l);queue().defer(d3.json,"https://s3-us-west-2.amazonaws.com/mode-alamode/states.json").await(y)},worldChoropleth:function(e){function y(e,n){d3.select("#mode-world-chorolpleth-"+t).append("g").attr("class","mode-world-chorolpleth-countries-base").selectAll(".mode-world-chorolpleth-countries").data(topojson.feature(n,n.objects.countries).features).enter().append("path").attr("class","mode-world-chorolpleth-countries").attr("fill",function(e){return g(p.get(e.properties[s]))}).attr("d",v).on("mouseover",function(e){var n=e.properties.name;p.get(e.properties[s])?value=p.get(e.properties[s]):value="--",d3.select("#mode-world-chorolpleth-legend-"+t).text(n+": "+value)}).on("mouseout",function(e){d3.select("#mode-world-chorolpleth-legend-"+t).text("Hover over a country to see details")}),d3.select("#mode-world-chorolpleth-"+t).append("path").datum(topojson.mesh(n,n.objects.countries,function(e,t){return e!==t})).attr("class","mode-world-chorolpleth-boundaries").attr("d",v)}var t=alamode.makeId(10),n=e.query_name,r=e.country_column,i=e.value_column,s=e.country_code_type,o=e.width||950,u=e.height||o*.8,a=e.title||n,f=e.color_range,l=e.color_gradient||["#9ecae1","#6baed6","#4292c6","#2171b5","#08519c","#08306b"],c=e.html_element||"body",h=alamode.getDataFromQuery(n),p=d3.map(),d=d3.geo.mercator().scale((o+1)/2/Math.PI).translate([o/2,u/2+u*.1]).precision(.1),v=d3.geoPath().projection(d),m=alamode.addContainerElement(c);d3.select(m).append("div").attr("class","mode-graphic-title").text(a),d3.select(m).append("div").attr("class","mode-world-chorolpleth-legend").attr("id","mode-world-chorolpleth-legend-"+t).text("Hover over a country to see details"),svg=d3.select(m).append("div").attr("class","mode-world-chorolpleth").append("svg").attr("id","mode-world-chorolpleth-"+t).attr("width",o).attr("height",u),h.forEach(function(e){p.set(e[r],+e[i])}),f?colorDomain=f:colorDomain=d3.extent(h,function(e){return e[i]});var g=d3.scale.quantize().domain(colorDomain).range(l);queue().defer(d3.json,"https://s3-us-west-2.amazonaws.com/mode-alamode/world.json").await(y)},pivotTable:function(e){var t=alamode.makeId(10),n=e.query_name,r=e.default_columns,i=e.default_rows,s=e.default_values,o=e.editable,u=e.aggregate_function||"Count",a=e.pivot_table_type||"Table",f=e.default_column_value||n,l=e.html_element||"body",c=e.default_exclusions||[],h=e.default_inclusions||[];Array.isArray(s)||(s=[s]);var p=alamode.getDataFromQuery(n),d=alamode.getColumnsFromQuery(n),v=_.map(d,"name"),m=alamode.addContainerElement(l);d3.select(m).append("div").attr("class","mode-graphic-title").text(f),d3.select(m).append("div").attr("class","mode-pivot-table").attr("id",t);var g=[];g.push(v),p.forEach(function(e){var t=[];v.forEach(function(n){t.push(e[n])}),g.push(t)});if(o)$("#"+t).pivotUI(g,{cols:r,rows:i,aggregatorName:u,vals:s,rendererName:a,exclusions:c,inclusions:h});else{var y=$.pivotUtilities,b=y.renderers[a],w=y.aggregators[u];$("#"+t).pivot(g,{cols:r,rows:i,aggregator:w(s),renderer:b,exclusions:c,inclusions:h})}},pieChartLabels:function(e){function s(e,t){e.find(".nv-legendWrap .nv-series text").each(function(n){var r=$(this).text();e.find(".nv-pieWrap .nv-pieLabels text").each(function(e){var s=n+"-"+e;text=$(this).text(),n==e&&text!=""&&text!=i[s]?text=r+" - "+text:n==e&&t&&text!=i[s]&&(text=r),i[s]=text,$(this).text(text)})})}var t=e.show_all_labels,n=e.chart_id,r=$("#"+n),i={};setInterval(function(){s(r,t)},300)},bigNumberSparkline:function(e){var t="#"+e.chart_id,n=e.x_axis_column,r=e.value_column,i=e.query_name,s=alamode.makeId(12),o=alamode.getDataFromQuery(i),u=alamode.getColumnsFromQuery(i);n?(xMatch=_.filter(u,{name:n}),xType=xMatch[0].type):xType="string";var a=[];o.forEach(function(e){xType=="datetime"||xType=="timestamp"||xType=="date"?formattedX=d3.time.format.utc("%Y-%m-%d")(new Date(Date.parse(e[n]))):formattedX=e[n];var t={x:formattedX,y:e[r]};a.push(t)});var f=$(t+" .chart-wrapper"),l=$(t+" .chart-big-number"),c=f.height(),h=f.width(),p=l.height(),d=c-p-20;d3.select(t+" .chart-big-number").append("svg").attr("height",d).attr("width",h).attr("id",s).append("g").attr("transform","translate(0,"+p+")"),nv.addGraph(function(){var e=nv.models.sparklinePlus().margin({left:15,right:15}).x(function(e,t){return t}).xTickFormat(function(e){return a[e].x}).showLastValue(!1);return d3.select("#"+s).datum(a).call(e),e}),setTimeout(function(){d3.selectAll(t+" path").style("stroke-width","2px").style("stroke-linejoin","round").style("stroke","#646C6C"),d3.selectAll(t+" .nv-minValue").style("fill","#EE7437").style("stroke","#EE7437").attr("r",3),d3.selectAll(t+" .nv-maxValue").style("fill","#37B067").style("stroke","#37B067").attr("r",3),d3.selectAll(t+" .nv-currentValue").style("fill","#22A3C0").style("stroke","#22A3C0").attr("r",3)},1e3)},addLinkToBigNumber:function(e){var t="#"+e.chart_id,n=e.url;$(t+" .chart-big-number .aggregate span"
).replaceWith(function(){var e=$.trim($(this).text());return"<a style='text-decoration: underline;' href='"+n+"' target='_blank'>"+e+"</a>"})},forceDirectedGraph:function(e){var t=alamode.makeId(10),n=e.node_query,r=e.edge_query,i=e.html_element||"body",s=e.title||queryName,o=e.chart_width||"800",u=e.chart_height||"800",a=e.group_colors||"",f=e.links_to_show||100,l=alamode.getDataFromQuery(n),c=alamode.getDataFromQuery(r),h=[];c.forEach(function(e){var t=h.filter(function(t){return t.target==e.source}),n=t.filter(function(t){return t.source==e.target});n.length!=0?n.edge_size+=e.edge_size:h.push(e)}),h=h.sort(function(e,t){return t.edge_size-e.edge_size}),h=h.slice(0,f),nameMap={},l.forEach(function(e,t){e.id=t,nameMap[e.node]=t}),h.forEach(function(e){e.source_id=nameMap[e.source],e.target_id=nameMap[e.target]});var p=alamode.addContainerElement(i);d3.select(p).append("div").attr("class","mode-graphic-title").text(s),d3.select(p).append("div").attr("class","mode-force-directed-graph").style("width",o).attr("id",t);var d=d3.tip().attr("class","mode-force-directed-graph-tooltip").offset([-10,0]).html(function(e){return e.node}),v=d3.layout.force().linkDistance(40).linkStrength(1).size([o,u]),m=d3.select("#"+t).append("svg").attr("width",o).attr("height",u);m.call(d);var g={nodes:l,links:h},y=d3.scale.linear().domain(d3.extent(l,function(e){return e.node_size})).range([2,20]),b=d3.scale.linear().domain(d3.extent(h,function(e){return e.edge_size})).range([1,10]),w=d3.scale.linear().domain(d3.extent(h,function(e){return e.edge_size})).range([.1,.9]),l=g.nodes.slice(),h=[],E=[];g.links.forEach(function(e){var t=l[e.source_id],n=l[e.target_id],r={};r.connections=e.edge_size,l.push(r),h.push({source:t,target:r},{source:r,target:n}),E.push([t,r,n])}),v.nodes(l).links(h).start();var S=m.selectAll(".mode-force-directed-graph-link ").data(E).enter().append("path").attr("class","mode-force-directed-graph-link").style("stroke-width",function(e){return b(e[1].connections)}).style("opacity",function(e){return w(e[1].connections)}),x=m.selectAll(".mode-force-directed-graph-node").data(g.nodes).enter().append("g").attr("class","mode-force-directed-graph-node").call(v.drag);x.append("circle").attr("r",function(e){return y(e.node_size)}).style("fill",function(e){return a?a[e.node_group]:"#0E819A"}).on("mouseover",d.show).on("mouseout",d.hide),v.on("tick",function(){S.attr("d",function(e){return"M"+e[0].x+","+e[0].y+"S"+e[1].x+","+e[1].y+" "+e[2].x+","+e[2].y}),x.attr("transform",function(e){return"translate("+e.x+","+e.y+")"})})},networkMatrix:function(e){function T(e){var t=d3.select(this).selectAll(".mode-network-matrix-cell").data(e.filter(function(e){return e.z})).enter().append("rect").attr("class","mode-network-matrix-cell").attr("x",function(e){return v(e.x)}).attr("width",v.rangeBand()).attr("height",v.rangeBand()).style("fill-opacity",function(e){return m(e.z)}).style("fill",function(e){return p[e.x].node_group==p[e.y].node_group?f[p[e.x].node_group]:"#2B2B2B"}).on("mouseover",function(e){C(e),y.show(e)}).on("mouseout",function(e){k(e),y.hide(e)})}function C(e){d3.selectAll(".mode-network-matrix-row-text").classed("active",function(t,n){return n==e.y}),d3.selectAll(".mode-network-matrix-column-text").classed("active",function(t,n){return n==e.x})}function k(){d3.selectAll("text").classed("active",!1)}function L(e){v.domain(x[e]);var t=w.transition().duration(1e3);t.selectAll(".mode-network-matrix-row").attr("transform",function(e,t){return"translate(0,"+v(t)+")"}).selectAll(".mode-network-matrix-cell").attr("x",function(e){return v(e.x)}),t.selectAll(".mode-network-matrix-column").attr("transform",function(e,t){return"translate("+v(t)+")rotate(-90)"})}var t=alamode.makeId(10),n=e.node_query,r=e.edge_query,i=e.html_element||"body",s=e.title||queryName,o=e.padding_for_names||"200",u=e.chart_width||"800",a=e.chart_height||"800",f=e.group_colors||"",l=e.left_label||"",c=e.top_label||"",h={top:o,right:10,bottom:10,left:o},p=alamode.getDataFromQuery(n),d=alamode.getDataFromQuery(r);nameMap={},p.forEach(function(e,t){e.id=t,nameMap[e.node]=t}),d.forEach(function(e){e.source_id=nameMap[e.source],e.target_id=nameMap[e.target]});var v=d3.scale.ordinal().rangeBands([0,u]),m=d3.scale.linear().domain(d3.extent(d,function(e){return e.edge_size})).clamp(!0),g=alamode.addContainerElement(i);d3.select(g).append("div").attr("class","mode-graphic-title").text(s),d3.select(g).append("div").attr("class","mode-network-matrix-order-picker").html('<p>Order: <select id="mode-network-matrix-order-picker-'+t+'">'+'<option value="name">Name</option>'+'<option value="count">Frequency</option>'+'<option value="group">Group</option></select>'),d3.select(g).append("div").attr("class","mode-network-matrix").style("width",u).attr("id",t);var y=d3.tip().attr("class","mode-network-matrix-tooltip").offset([-10,0]).html(function(e){return e.z}),b=d3.select("#"+t).append("svg").attr("width",u+h.left+h.right).attr("height",a+h.top+h.bottom);b.call(y);var w=b.append("g").attr("transform","translate("+h.left+","+h.top+")");graph={nodes:p,links:d};var E=[],p=graph.nodes,S=p.length;p.forEach(function(e,t){e.index=t,e.count=0,E[t]=d3.range(S).map(function(e){return{x:e,y:t,z:0}})}),graph.links.forEach(function(e){typeof E[e.source_id][e.target_id]!="undefined"?(E[e.source_id][e.target_id].z+=e.edge_size,p[e.source_id].count+=e.edge_size,p[e.target_id].count+=e.edge_size):(E[e.source_id][e.target_id]={},E[e.source_id][e.target_id].z=0)});var x={name:d3.range(S).sort(function(e,t){return d3.ascending(p[e].node,p[t].node)}),count:d3.range(S).sort(function(e,t){return p[t].count-p[e].count}),group:d3.range(S).sort(function(e,t){return d3.ascending(p[e].node_group,p[t].node_group)})};v.domain(x.name),b.append("text").attr("class","mode-network-matrix-axis-label").attr("x",(u+h.left+h.right)/2).attr("y",25).attr("text-anchor","middle").text(c),b.append("text").attr("class","mode-network-matrix-axis-label").attr("x",(a+h.top+h.bottom)/-2).attr("y",25).attr("transform","rotate(-90)").attr("text-anchor","middle").text(l),w.append("rect").attr("class","mode-network-matrix-background").attr("width",u).attr("height",a);var T=w.selectAll(".mode-network-matrix-row").data(E).enter().append("g").attr("class","mode-network-matrix-row").attr("transform",function(e,t){return"translate(0,"+v(t)+")"}).each(T);T.append("line").attr("class","mode-network-matrix-line").attr("x2",u),T.append("text").attr("class","mode-network-matrix-row-text").attr("x",-6).attr("y",v.rangeBand()/2).attr("dy",".32em").attr("text-anchor","end").text(function(e,t){return p[t].node});var N=w.selectAll(".mode-network-matrix-column").data(E).enter().append("g").attr("class","mode-network-matrix-column").attr("transform",function(e,t){return"translate("+v(t)+")rotate(-90)"});N.append("line").attr("class","mode-network-matrix-line").attr("x1",-u),N.append("text").attr("class","mode-network-matrix-column-text").attr("x",6).attr("y",v.rangeBand()/2).attr("dy",".32em").attr("text-anchor","start").text(function(e,t){return p[t].node}),d3.select("#mode-network-matrix-order-picker-"+t).on("change",function(){L(this.value)})},hive:function(e){function w(e){return e/Math.PI*180-90}d3.hive={},d3.hive.link=function(){function e(e,i){var s,o=t(n,this,e,i),u=t(r,this,e,i);o.a>u.a&&(s=u,u=o,o=s),u.a-o.a>Math.PI&&(o.a+=2*Math.PI);var a=o.a+(u.a-o.a)/3,f=u.a-(u.a-o.a)/3;return o.r0-o.r1||u.r0-u.r1?"M"+Math.cos(o.a)*o.r0+","+Math.sin(o.a)*o.r0+"L"+Math.cos(o.a)*o.r1+","+Math.sin(o.a)*o.r1+"C"+Math.cos(a)*o.r1+","+Math.sin(a)*o.r1+" "+Math.cos(f)*u.r1+","+Math.sin(f)*u.r1+" "+Math.cos(u.a)*u.r1+","+Math.sin(u.a)*u.r1+"L"+Math.cos(u.a)*u.r0+","+Math.sin(u.a)*u.r0+"C"+Math.cos(f)*u.r0+","+Math.sin(f)*u.r0+" "+Math.cos(a)*o.r0+","+Math.sin(a)*o.r0+" "+Math.cos(o.a)*o.r0+","+Math.sin(o.a)*o.r0:"M"+Math.cos(o.a)*o.r0+","+Math.sin(o.a)*o.r0+"C"+Math.cos(a)*o.r1+","+Math.sin(a)*o.r1+" "+Math.cos(f)*u.r1+","+Math.sin(f)*u.r1+" "+Math.cos(u.a)*u.r1+","+Math.sin(u.a)*u.r1}function t(e,t,n,r){var a=e.call(t,n,r),f=+("function"==typeof i?i.call(t,a,r):i)+u,l=+("function"==typeof s?s.call(t,a,r):s),c=s===o?l:+("function"==typeof o?o.call(t,a,r):o);return{r0:l,r1:c,a:f}}var n=function(e){return e.source},r=function(e){return e.target},i=function(e){return e.angle},s=function(e){return e.radius},o=s,u=-Math.PI/2;return e.source=function(t){return arguments.length?(n=t,e):n},e.target=function(t){return arguments.length?(r=t,e):r},e.angle=function(t){return arguments.length?(i=t,e):i},e.radius=function(t){return arguments.length?(s=o=t,e):s},e.startRadius=function(t){return arguments.length?(s=t,e):s},e.endRadius=function(t){return arguments.length?(o=t,e):o},e};var t=alamode.makeId(10),n=e.node_query,r=e.edge_query,i=e.groups_are_numeric,s=e.html_element||"body",o=e.title||queryName,u=e.chart_width||"800",a=e.chart_height||"800",f=e.group_colors||"",l=Math.min(u,a)/2-30,c=l*.2,h=alamode.getDataFromQuery(n),p=alamode.getDataFromQuery(r),d=_.uniq(_.map(h,"node_group")),v={};h.forEach(function(e){i?e.x=e.node_group:e.x=d.indexOf(e.node_group),e.y=e.node_size,v[e.node]=e}),p.forEach(function(e){e.source=v[e.source],e.target=v[e.target]});var m=alamode.addContainerElement(s);d3.select(m).append("div").attr("class","mode-graphic-title").text(o),d3.select(m).append("div").attr("class","mode-network-matrix").style("width",u).attr("id",t),i?angle=d3.scale.linear().domain(d3.extent(h,function(e){return e.node_group})).range([0,2*Math.PI]):angle=d3.scale.ordinal().domain(d3.range(d.length+1)).rangePoints([0,2*Math.PI]);var g=d3.scale.linear().domain(d3.extent(h,function(e){return e.node_size})).range([c,l]),y=d3.tip().attr("class","mode-hive-tooltip").offset([-10,0]).html(function(e){return e.node}),b=d3.select("#"+t).append("svg").attr("width",u).attr("height",a).append("g").attr("transform","translate("+u/2+","+a/2+")");b.call(y),b.selectAll(".mode-hive-axis").data(d3.range(d.length)).enter().append("line").attr("class","mode-hive-axis").attr("transform",function(e){return"rotate("+w(angle(e))+")"}).attr("x1",g.range()[0]).attr("x2",g.range()[1]),b.selectAll(".mode-hive-link").data(p).enter().append("path").attr("class","mode-hive-link").attr("d",d3.hive.link().angle(function(e){return angle(e.x)}).radius(function(e){return g(e.y)})).style("stroke",function(e){return f[e.source.node_group]}),b.selectAll(".mode-hive-node").data(h).enter().append("circle").attr("class","mode-hive-node").attr("transform",function(e){return"rotate("+w(angle(e.x))+")"}).attr("cx",function(e){return g(e.y)}).attr("r",5).style("fill",function(e){return f[e.node_group]}).on("mouseover",function(e){y.show(e),d3.select(this).attr("class","mode-hive-node mode-hive-node-selected"),d3.selectAll(".mode-hive-link").data(p).attr("class",function(t){return t.source.node==e.node?"mode-hive-link-selected":t.target.node==e.node?"mode-hive-link-selected":"mode-hive-link"})}).on("mouseout",function(e){y.hide(e),d3.select(this).attr("class","mode-hive-node"),d3.selectAll(".mode-hive-link-selected").attr("class","mode-hive-link")})},conditionalFormattingByColumn:function(e){function u(e){var n=$(t+" table"),r=$(t+" .js-header-table"),i=r?$(t+" .js-col-header"):$(r).find("th"),s=n.find("tr"),u=0;i.each(function(){text=$(this).find(".axel-table-header-label").text(),u=$(this).attr("data-axel-column"),o[text]=u}),e.forEach(function(e){e.rules.forEach(function(t){var n=t.shade_text||!1;t.type=="gradient"?a(e.column,t.color,n):(t.type=="above"||t.type=="below"||t.type=="equal")&&f(e.column,t.type,t.value,t.color,n)})})}function a(e,n,r){var s=d3.extent(_.map(i,e)),u=d3.scale.linear().domain(s).interpolate(d3.interpolateHsl).range(n),a=o[e];i.forEach(function(n,i){var s=t+" table [data-axel-rowkey='"+i+"'][data-axel-column='"+a+"']",o=u(n[e]),f=c(o),l=$(s);r?l.css("color",o):l.css({background:o,color:f})})}function f(e,n,r,s,u){var a=o[e],f=c(s);i.forEach(function(i,o){var l=t+" table [data-axel-rowkey='"+o+"'][data-axel-column='"+a+"']",c=$(l);n!="above"||i[e]<r?n!="below"||i[e]>r?n=="equal"&&i[e]==r&&(u?c.css("color",s):c.css({background:s,color:f})):u?c.css("color",s):c.css({background:s,color:f}):u?c.css("color",s):c.css({background:s,color:f})})}function l(e){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}function c(t){var n=/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(t);return n?(rgb=l(t),e=Math.round((parseInt(rgb.r)*299+parseInt(rgb.g)*587+parseInt(rgb.b)*114)/1e3)):e=255,e>125?"#2B2B2B":"#FCFCFC"}var t="#"+e.table_id,n=e.query_name,r=e.column_rules,i=alamode.getDataFromQuery(n),s=alamode.getColumnsFromQuery(n),o={};setTimeout(function(){u(r)},1e3),$(t).mousemove(function(){u(r)})},conditionalFormattingByTable:function(e){function f(e){var n=$(t+" table"),r=$(t+" .js-header-table"),i=r?$(t+" .js-col-header"):$(r).find("th"),s=n.find("tr"),u=0;i.each(function(){text=$(this).find(".axel-table-header-label").text(),u=$(this).attr("data-axel-column"),o[text]=u}),e.forEach(function(e){var t=e.shade_text||!1;e.type=="gradient"?l(e.color,t):(e.type=="above"||e.type=="below"||e.type=="equal")&&c(e.type,e.value,e.color,t)})}function l(e,n){var s=d3.scale.linear().domain(a).interpolate(d3.interpolateHsl).range(e);i.forEach(function(e,i){r.forEach(function(r){var u=o[r],a=t+" table [data-axel-rowkey='"+i+"'][data-axel-column='"+u+"']",f=s(e[r]),l=p(f),c=$(a);n?c.css("color",f):c.css({background:f,color:l})})})}function c(e,n,s,u){var a=p(s);i.forEach(function(i,f){r.forEach(function(r){var l=o[r],c=t+" table [data-axel-rowkey='"+f+"'][data-axel-column='"+l+"']",h=$(c);e!="above"||i[r]<n?e!="below"||i[r]>n?e=="equal"&&i[r]==n&&(u?h.css("color",s):h.css({background:s,color:a})):u?h.css("color",s):h.css({background:s,color:a}):u?h.css("color",s):h.css({background:s,color:a})})})}function h(e){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}function p(t){var n=/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(t);return n?(rgb=h(t),e=Math.round((parseInt(rgb.r)*299+parseInt(rgb.g)*587+parseInt(rgb.b)*114)/1e3)):e=255,e>125?"#2B2B2B":"#FCFCFC"}var t="#"+e.table_id,n=e.query_name,r=e.columns;rules=e.rules;var i=alamode.getDataFromQuery(n),s=alamode.getColumnsFromQuery(n),o={},u=[];r.forEach(function(e){var t=d3.extent(_.map(i,e));u=u.concat(t)});var a=d3.extent(u);setTimeout(function(){f(rules)},1e3),$(t).mousemove(function(){f(rules)})},addTableOfContents:function(e){typeof e=="undefined"&&(e="default");var t=e.text_color,n=e.background_color,r=e.hover_color;$(".mode-header").addClass("has-nav");var i=$("<nav class='fixed-nav-bar'></nav>");$(".row").each(function(){var e=$(this).children();e.each(function(){var e,t=$(this).find("mode-chart").attr("id")||$(this).find("mode-table").attr("id")||$(this).find("mode-python").attr("id");if(!t)return!0;if(t.includes("chart")||t.includes("table")){var n=document.getElementById(t);$(n).find("mode-pivot-table").length>0?e=document.getElementById(t).getElementsByClassName("in-place-edit-text")[0].innerText:e=document.getElementById(t).getElementsByClassName("chart-title")[0].innerText}else t.includes("python")&&(e=document.getElementById(t).getElementsByClassName("in-place-edit-text")[0].innerText);var r=$("<a class='scroll-link' href=#"+t+">"+(e.includes("Click to add title")?"Untitled":e)+"</a>");i.append(r)})});var s=$("<div class='mode-grid container''></div>");$(".mode-content").prepend(s);var o=$("<div class='row'></div>");s.prepend(o);var u=$("<div class='col-md-12'></div>");o.prepend(u),u.prepend(i),!t||$(".fixed-nav-bar a").css("color",t),!n||$(".fixed-nav-bar").css("background-color",n),!r||$(".fixed-nav-bar a").hover(function(){$(this).css("color",r)},function(){t?$(this).css("color",t):$(this).css("color","")}),setTimeout(function(){function e(e,t){var n=50,r=$(e).offset().top-n;$("html,body").animate({scrollTop:r},t)}$(".scroll-link").on("click",function(t){t.preventDefault();var n=$(this).attr("href");e(n,750)})},100)}};